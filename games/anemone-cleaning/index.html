<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      // WebXR requires https: to work so ensure redirected if needed.
      if (location.hostname !== "localhost" && window.location.protocol === "http:" )
        window.location.protocol = "https:";
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <title>Animals Everywhere</title>
  </head>

  <!-- External Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=BentonSans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=BentonSans+Book:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <style>
    .a-enter-vr-button{
      display: none;
    }
    .a-enter-ar-button{
      display: none;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .overlay.hidden {
      display: none;
    }
    .popup-content {
      width: 85%;
      max-width: 550px;
      height: 75%;
      max-height: 650px;
      margin: -10vh auto 0;
      background-color: #FFF5E9;
      border-radius: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .popup-content header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 15px;
      background-color: #FFF5E9;
    }
    .popup-content h1 {
      margin: 0;
      font-family: 'Amatic SC', cursive;
      font-size: 1.8rem;
      color: #333;
    }
     .how-to-play {
       flex: 1;
       padding: 8px 15px 80px 15px;
       display: flex;
       flex-direction: column;
       justify-content: space-between;
       align-items: center;
       gap: 8px;
     }
     .instruction {
       width: 100%;
       margin-bottom: 8px;
       display: flex;
       align-items: center;
       gap: 8px;
     }
     .instruction.reverse {
       flex-direction: row;
     }
     .instruction.reverse .instruction-icon {
       flex-direction: row;
     }
    .instruction-icon {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
      flex: 1;
      min-width: 0;
    }
     .instruction-image {
       flex-shrink: 0;
       width: 80px;
       height: 80px;
       object-fit: contain;
     }
     .instruction img.number-icon {
       width: 30px;
       height: auto;
     }
    .instruction-text {
      font-size: 0.9rem;
      margin: 0;
      flex: 1;
      word-wrap: break-word;
      line-height: 1.4;
    }
      .instruction img.instruction-image {
        max-width: 100%;
        height: auto;
        max-height: 80px;
        object-fit: contain;
      }
     #howToPlay .popup-content footer {
       position: absolute !important;
       bottom: 24px !important;
       left: 0 !important;
       right: 0 !important;
       width: 100% !important;
       display: flex !important;
       justify-content: center !important;
       align-items: center !important;
       padding: 0 !important;
       margin: 0 !important;
       height: 60px !important;
     }
     
     #howToPlay .popup-content footer .main-button {
       margin: 0 !important;
       transform: none !important;
     }
     
     #howToPlay .popup-content footer .main-button:hover {
       transform: none !important;
     }
     
     #howToPlay .popup-content footer .main-button:active {
       transform: none !important;
     }
     
     #howToPlay .popup-content header {
       padding-top: 24px !important;
     }
     
     #howToPlay .popup-content header h1 {
       color: #3A2E27 !important;
       text-align: center !important;
       -webkit-text-stroke-width: 0.5px !important;
       -webkit-text-stroke-color: #3A2E27 !important;
       font-family: "Amatic SC" !important;
       font-size: 32px !important;
       font-style: normal !important;
       font-weight: 400 !important;
       line-height: 120% !important;
     }
     
     #howToPlay .popup-content {
       border-radius: 24px !important;
       border: 2px solid #E7D4A3 !important;
       background: #FCF6EF !important;
       box-shadow: 0 4px 0 0 #E7D4A3 !important;
     }
    .back-button {
      display: flex;
      align-items: center;
      gap: 10px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'BentonSans Comp Black', sans-serif;
      font-weight: 400;
      font-size: 24px;
      padding: 12px;
      background: #BD3B00;
      color: #FCEFE1;
      box-shadow: 0px 4px 0px 0px #962F00;
      transition: all 0.2s ease;
    }
    .back-button:hover {
      transform: translateY(2px);
      box-shadow: 0px 2px 0px 0px #962F00;
    }
    .back-button:active {
      transform: translateY(4px);
      box-shadow: none;
    }
     .back-button img {
       width: 24px;
       height: 24px;
     }
    .header-placeholder {
      width: 48px;
    }
    .main-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'BentonSans Comp Black', sans-serif;
      font-weight: 400;
      font-size: 24px;
      padding: 12px 24px;
      background: #BD3B00;
      color: #FCEFE1;
      width: 220px;
      box-shadow: 0px 4px 0px 0px #962F00;
      transition: all 0.2s ease;
    }
    .main-button:hover {
      transform: translateY(2px);
      box-shadow: 0px 2px 0px 0px #962F00;
    }
     .main-button:active {
       transform: translateY(4px);
       box-shadow: none;
     }
     .main-button:disabled {
       background: #999;
       color: #ccc;
       box-shadow: 0px 4px 0px 0px #666;
       cursor: not-allowed;
       opacity: 0.6;
     }
     .main-button:disabled:hover {
       transform: none;
       box-shadow: 0px 4px 0px 0px #666;
     }
     .main-button:disabled:active {
       transform: none;
       box-shadow: 0px 4px 0px 0px #666;
     }
     .main-button:not(:disabled) {
       background: #BD3B00;
       color: #FCEFE1;
       box-shadow: 0px 4px 0px 0px #962F00;
       cursor: pointer;
       opacity: 1;
     }
     
     .main-button.button-enabled {
       animation: buttonPulse 0.5s ease-in-out;
     }
     
     @keyframes buttonPulse {
       0% { transform: scale(1); }
       50% { transform: scale(1.05); }
       100% { transform: scale(1); }
     }
    @media (max-height: 700px) {
      .popup-content {
        height: 80%;
        margin: -10vh auto 0;
      }
      .how-to-play {
        gap: 5px;
      }
      .instruction {
        margin-bottom: 4px;
      }
      .instruction img.instruction-image {
        max-height: 80px;
      }
    }

    /* Orientation Warning Overlay */
    .orientation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .orientation-content {
      background-color: #FCF6EF;
      border: 3px solid #E7D4A3;
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      max-width: 300px;
      margin: 1rem;
      box-shadow: 0px 4px 0px 0px #E7D4A3;
    }

        .orientation-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: rotateToPortrait 2.5s ease-in-out infinite;
            transform-origin: 0 100%;
            display: inline-block;
        }

    .orientation-content h2 {
      color: #C14400;
      font-family: "Amatic SC", sans-serif;
      font-weight: 700;
      font-size: 2rem;
      margin: 0 0 1rem 0;
    }

    .orientation-content p {
      color: #333;
      font-size: 1.1rem;
      margin: 0;
      line-height: 1.4;
    }

        @keyframes rotateToPortrait {
            0% { transform: rotate(-90deg); opacity: 1; }
            40% { transform: rotate(0deg); opacity: 1; }
            60% { transform: rotate(0deg); opacity: 1; }
            70% { transform: rotate(0deg); opacity: 0; }
            71% { transform: rotate(-90deg); opacity: 0; }
            80% { transform: rotate(-90deg); opacity: 1; }
            100% { transform: rotate(-90deg); opacity: 1; }
        }

        /* Hidden class for orientation overlay */
        .hidden {
            display: none !important;
        }

        /* Underwater Camera Distortion Effect */
        video {
            filter: 
                hue-rotate(200deg) 
                saturate(2.5) 
                contrast(1.4) 
                brightness(0.7)
                sepia(0.3);
            animation: underwaterDistortion 3s ease-in-out infinite;
        }

        @keyframes underwaterDistortion {
            0% {
                filter: 
                    hue-rotate(200deg) 
                    saturate(2.5) 
                    contrast(1.4) 
                    brightness(0.7)
                    sepia(0.3)
                    blur(0px);
            }
            12.5% {
                filter: 
                    hue-rotate(200.5deg) 
                    saturate(2.52) 
                    contrast(1.41) 
                    brightness(0.695)
                    sepia(0.305)
                    blur(0.3px);
            }
            25% {
                filter: 
                    hue-rotate(201deg) 
                    saturate(2.54) 
                    contrast(1.42) 
                    brightness(0.69)
                    sepia(0.31)
                    blur(0.6px);
            }
            37.5% {
                filter: 
                    hue-rotate(201.5deg) 
                    saturate(2.56) 
                    contrast(1.43) 
                    brightness(0.685)
                    sepia(0.315)
                    blur(0.9px);
            }
            50% {
                filter: 
                    hue-rotate(202deg) 
                    saturate(2.58) 
                    contrast(1.44) 
                    brightness(0.68)
                    sepia(0.32)
                    blur(1.2px);
            }
            62.5% {
                filter: 
                    hue-rotate(201.5deg) 
                    saturate(2.56) 
                    contrast(1.43) 
                    brightness(0.685)
                    sepia(0.315)
                    blur(0.9px);
            }
            75% {
                filter: 
                    hue-rotate(201deg) 
                    saturate(2.54) 
                    contrast(1.42) 
                    brightness(0.69)
                    sepia(0.31)
                    blur(0.6px);
            }
            87.5% {
                filter: 
                    hue-rotate(200.5deg) 
                    saturate(2.52) 
                    contrast(1.41) 
                    brightness(0.695)
                    sepia(0.305)
                    blur(0.3px);
            }
            100% {
                filter: 
                    hue-rotate(200deg) 
                    saturate(2.5) 
                    contrast(1.4) 
                    brightness(0.7)
                    sepia(0.3)
                    blur(0px);
            }
        }

        /* Water overlay for color tinting - only over camera feed */
        .water-filter {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0.5;  /* Between camera (0) and 3D scene (1+) */
            background: linear-gradient(
                to bottom,
                rgba(0, 150, 255, 0.4) 0%,     /* Strong turquoise */
                rgba(0, 80, 200, 0.6) 50%,   /* Strong medium blue */
                rgba(0, 40, 120, 0.8) 100%   /* Very strong dark blue */
            );
            animation: waterTint 4s ease-in-out infinite;
        }

        @keyframes waterTint {
            0%, 100% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 150, 255, 0.4) 0%,
                    rgba(0, 80, 200, 0.6) 50%,
                    rgba(0, 40, 120, 0.8) 100%
                );
            }
            10% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 152, 255, 0.401) 0%,
                    rgba(0, 81, 201, 0.601) 50%,
                    rgba(0, 41, 121, 0.801) 100%
                );
            }
            20% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 154, 255, 0.402) 0%,
                    rgba(0, 82, 202, 0.602) 50%,
                    rgba(0, 42, 122, 0.802) 100%
                );
            }
            30% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 156, 255, 0.403) 0%,
                    rgba(0, 83, 203, 0.603) 50%,
                    rgba(0, 43, 123, 0.803) 100%
                );
            }
            40% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 158, 255, 0.404) 0%,
                    rgba(0, 84, 204, 0.604) 50%,
                    rgba(0, 44, 124, 0.804) 100%
                );
            }
            50% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 160, 255, 0.405) 0%,
                    rgba(0, 85, 205, 0.605) 50%,
                    rgba(0, 45, 125, 0.805) 100%
                );
            }
            60% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 158, 255, 0.404) 0%,
                    rgba(0, 84, 204, 0.604) 50%,
                    rgba(0, 44, 124, 0.804) 100%
                );
            }
            70% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 156, 255, 0.403) 0%,
                    rgba(0, 83, 203, 0.603) 50%,
                    rgba(0, 43, 123, 0.803) 100%
                );
            }
            80% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 154, 255, 0.402) 0%,
                    rgba(0, 82, 202, 0.602) 50%,
                    rgba(0, 42, 122, 0.802) 100%
                );
            }
            90% {
                background: linear-gradient(
                    to bottom,
                    rgba(0, 152, 255, 0.401) 0%,
                    rgba(0, 81, 201, 0.601) 50%,
                    rgba(0, 41, 121, 0.801) 100%
                );
            }
        }

        /* Wave Effect */
        .wave-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0.3;
            opacity: 0.3;
            background-image: url('assets/wave.png');
            background-size: 100% 200%;
            background-repeat: repeat-y;
            background-position: center 0%;
            animation: waveTexture 30s linear infinite;
        }

        @keyframes waveTexture {
            0% {
                background-position: center 0%;
                opacity: 0.3;
            }
            75% {
                background-position: center 75%;
                opacity: 0.3;
            }
            85% {
                background-position: center 85%;
                opacity: 0.2;
            }
            90% {
                background-position: center 90%;
                opacity: 0.1;
            }
            95% {
                background-position: center 95%;
                opacity: 0.05;
            }
            100% {
                background-position: center 100%;
                opacity: 0.3;
            }
        }

        /* Bubble Container */
        .bubble-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0.4;
            overflow: hidden;
        }

        /* Top fade zone for bubbles */
        .bubble-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 15vh;
            background: linear-gradient(
                to bottom,
                rgba(0, 150, 200, 0.6) 0%,
                rgba(0, 100, 150, 0.3) 50%,
                transparent 100%
            );
            z-index: 1;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            animation: bubbleFloat 8s linear infinite;
        }


        @keyframes bubbleFloat {
            0% {
                transform: translateY(100vh) translateX(0px);
                opacity: 0;
            }
            10% {
                opacity: var(--bubble-opacity, 0.7);
            }
            25% {
                transform: translateY(75vh) translateX(var(--drift-1, 0px));
                opacity: var(--bubble-opacity, 0.7);
            }
            50% {
                transform: translateY(50vh) translateX(var(--drift-2, 0px));
                opacity: var(--bubble-opacity, 0.7);
            }
            75% {
                transform: translateY(25vh) translateX(var(--drift-3, 0px));
                opacity: var(--bubble-opacity, 0.7);
            }
            80% {
                opacity: var(--bubble-opacity, 0.7);
            }
            85% {
                opacity: calc(var(--bubble-opacity, 0.7) * 0.4);
            }
            100% {
                transform: translateY(-20vh) translateX(var(--drift-4, 0px));
                opacity: 0;
            }
        }
  </style>
  <!-- Packages -->
  <script src="ammo.wasm.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@latest/dist/aframe-particle-system-component.min.js"></script>
  
  <!-- Local Components -->
  <script src="physics-utils.js"></script>
  <script src="standard-utils.js"></script>
  <script src="scrubbable.js"></script>

  
  <!--  Overlay functions  -->
  <script>
    let firstStart = false
    function openHowToPlay() {
      document.querySelector('#click-sfx').emit('startsound')
      document.getElementById('howToPlay').classList.remove('hidden');
      // Hide instructions when opening how-to-play
      hideInstructions();
    }
    
    // Ensure hideInstructions function exists to prevent errors
    function hideInstructions() {
      const instructions = document.querySelector('#instructions');
      if (instructions) {
        instructions.style.opacity = '0';
      }
    }
    
    function showInstructions() {
      const instructions = document.querySelector('#instructions');
      if (instructions) {
        instructions.style.opacity = '1';
      }
    }
    function closeHowToPlay() {
      document.querySelector('#click-sfx').emit('startsound')
      document.getElementById('howToPlay').classList.add('hidden');
      if(!firstStart) {
        startAudio()
        firstStart = true
      }
      // Show instructions after a short delay when closing how-to-play
      setTimeout(showInstructions, 500);
    }
    function backHowToPlay() {
      document.querySelector('#click-sfx').emit('startsound')
      window.top.location.href = '../../games.html';
    }
    function openCongratulations() {
      // Stop background music - pause direct audio and mute A-Frame sound
      const backgroundAudio = document.getElementById('background-mp3');
      if (backgroundAudio) {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
      }
      
      // Mute the A-Frame background sound instead of stopping it completely
      const backgroundSfx = document.querySelector('#background-sfx');
      if (backgroundSfx && backgroundSfx.components.sound) {
        backgroundSfx.setAttribute('sound', 'volume', 0);
      }
      
      document.getElementById('gamecomplete').classList.remove('hidden')
    }
    function closeCongratulations() {
      document.getElementById('gamecomplete').classList.add('hidden')
      document.querySelector('#click-sfx').emit('startsound')
    }
    
    function showBadgeCollection() {
      // Stop background music - pause direct audio and mute A-Frame sound
      const backgroundAudio = document.getElementById('background-mp3');
      if (backgroundAudio) {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
      }
      
      // Mute the A-Frame background sound instead of stopping it completely
      const backgroundSfx = document.querySelector('#background-sfx');
      if (backgroundSfx && backgroundSfx.components.sound) {
        backgroundSfx.setAttribute('sound', 'volume', 0);
      }
      
      // Add badge to collection
      if (typeof addBadge === 'function') {
        addBadge('anemone');
      } else {
        // Fallback for when badges page isn't loaded
        let collectedBadges = JSON.parse(localStorage.getItem('collectedBadges') || '[]');
        if (!collectedBadges.includes('anemone')) {
          collectedBadges.push('anemone');
          localStorage.setItem('collectedBadges', JSON.stringify(collectedBadges));
        }
      }
      
      // Hide the game complete popup
      document.getElementById('gamecomplete').classList.add('hidden');
      
      // Play TaDA celebration sound
      const tadaAudio = document.getElementById('tada-wav');
      if (tadaAudio) {
        tadaAudio.play().catch(e => console.log('TaDA audio play failed:', e));
      }
      
      // Show the badge splash with congratulations
      const badgeSplash = document.getElementById('badgeSplash');
      badgeSplash.classList.remove('hidden');
      
      // Auto-dismiss splash after 4 seconds and show detail screen
      setTimeout(() => {
        badgeSplash.classList.add('hidden');
        document.getElementById('badgeCollection').classList.remove('hidden');
      }, 4000);
    }
    
    function restartGame() {
      // Play button tap sound
      document.querySelector('#click-sfx').emit('startsound');
      // Close congratulations popup
      document.getElementById('gamecomplete').classList.add('hidden');
      // Close badge collection
      document.getElementById('badgeCollection').classList.add('hidden');
      // Reset game state
      cleanCount = 0;
      
      // Reset anemone textures and previous states
      const anemone = document.querySelector('#anemone');
      if (anemone.components['zone-textures']) {
        // Reset the previous states to prevent particle triggering
        anemone.components['zone-textures'].previousStates = { a: 1, b: 1, c: 1, d: 1 };
      }
      anemone.setAttribute('zone-textures', {
        a: 1, b: 1, c: 1, d: 1
      });
      
      // Reset dirt elements (hit targets) with a small delay to ensure components are loaded
      setTimeout(() => {
        document.querySelectorAll('[id^="dirt"]').forEach(dirt => {
          dirt.setAttribute('visible', 'false');
          dirt.setAttribute('scale', '1 1 1');
          
          // Reset scrubbable component if it exists
          if (dirt.components && dirt.components.scrubbable) {
            console.log('Resetting scrubbable component for:', dirt.id);
            // Reset the component's internal state
            dirt.components.scrubbable.scrubbedTicks = 0;
            dirt.components.scrubbable.milestone = 0;
            dirt.components.scrubbable.screentouched = false;
            dirt.components.scrubbable.positionArray = [];
          } else {
            console.log('Scrubbable component not found for:', dirt.id);
          }
        });
      }, 100);
      
      // Clear any existing particles
      document.querySelectorAll('[id^="particle-"]').forEach(particleEl => {
        if (particleEl.components['particle-effects'] && particleEl.components['particle-effects'].particleSystem) {
          if (particleEl.components['particle-effects'].particleSystem.parentNode) {
            particleEl.removeChild(particleEl.components['particle-effects'].particleSystem);
          }
          particleEl.components['particle-effects'].particleSystem = null;
        }
      });
      
      // Reset hint text
      document.querySelector('#hint').innerHTML = "Rub the anemones with your finger to clean them.";
      // Show instructions
      showInstructions();
    }
    
    function goHome() {
      window.top.location.href = '../../badges.html';
    }
    
    // Underwater effect control functions
    function toggleUnderwaterEffect() {
      const video = document.querySelector('video');
      const waterFilter = document.getElementById('waterFilter');
      
      if (video.style.animation === 'none') {
        // Enable underwater effect
        video.style.animation = 'underwaterDistortion 4s ease-in-out infinite';
        waterFilter.style.display = 'block';
      } else {
        // Disable underwater effect
        video.style.animation = 'none';
        video.style.filter = 'none';
        waterFilter.style.display = 'none';
      }
    }
    
    function setUnderwaterIntensity(intensity) {
      const waterFilter = document.getElementById('waterFilter');
      waterFilter.style.opacity = intensity;
    }
    
    // Initialize underwater effect on load
    window.addEventListener('load', function() {
      // Start with underwater effect enabled
      const video = document.querySelector('video');
      const waterFilter = document.getElementById('waterFilter');
      
      if (video && waterFilter) {
        video.style.animation = 'underwaterDistortion 4s ease-in-out infinite';
        waterFilter.style.display = 'block';
      }
      
      // Start bubble generation
      startBubbleGeneration();
    });

    // Bubble generation system
    function createBubble() {
      const bubbleContainer = document.getElementById('bubbleContainer');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      
      // Random size between 8px and 25px
      const size = Math.random() * 17 + 8;
      bubble.style.width = size + 'px';
      bubble.style.height = size + 'px';
      
      // Use bubble PNG as background image
      bubble.style.backgroundImage = 'url(assets/bubble.png)';
      bubble.style.backgroundSize = 'contain';
      bubble.style.backgroundRepeat = 'no-repeat';
      bubble.style.backgroundPosition = 'center';
      
      // Random horizontal position (avoid top 10% of screen)
      const horizontalPosition = Math.random() * 100;
      bubble.style.left = horizontalPosition + '%';
      
      // Random horizontal drift values for realistic movement
      const drift1 = (Math.random() - 0.5) * 40; // -20px to +20px
      const drift2 = (Math.random() - 0.5) * 60; // -30px to +30px
      const drift3 = (Math.random() - 0.5) * 80; // -40px to +40px
      const drift4 = (Math.random() - 0.5) * 100; // -50px to +50px
      
      bubble.style.setProperty('--drift-1', drift1 + 'px');
      bubble.style.setProperty('--drift-2', drift2 + 'px');
      bubble.style.setProperty('--drift-3', drift3 + 'px');
      bubble.style.setProperty('--drift-4', drift4 + 'px');
      
      // Random opacity between 20% and 60%
      const opacity = Math.floor(Math.random() * 41) + 20; // 20-60%
      bubble.style.setProperty('--bubble-opacity', (opacity / 100).toString());
      
      // Random animation duration (6-12 seconds)
      const duration = Math.random() * 6 + 6;
      bubble.style.animationDuration = duration + 's';
      
      // Random delay (0-3 seconds)
      const delay = Math.random() * 3;
      bubble.style.animationDelay = delay + 's';
      
      bubbleContainer.appendChild(bubble);
      
      // Remove bubble after animation completes
      setTimeout(() => {
        if (bubble.parentNode) {
          bubble.parentNode.removeChild(bubble);
        }
      }, (duration + delay) * 1000);
    }

    function startBubbleGeneration() {
      // Create initial bubbles
      for (let i = 0; i < 3; i++) {
        setTimeout(() => createBubble(), i * 2000);
      }
      
      // Continue creating bubbles every 2-4 seconds
      setInterval(() => {
        // Only create bubble if not in top 10% of screen
        const screenHeight = window.innerHeight;
        const top10Percent = screenHeight * 0.1;
        
        // Check if we're in the top 10% - if so, skip this bubble
        if (Math.random() < 0.1) {
          return; // Skip creating bubble 10% of the time to avoid top area
        }
        
        createBubble();
      }, Math.random() * 2000 + 2000);
    }

    // Add this at the start of your script section
    window.onload = function() {
      // Skip directly to how-to-play like sunflower game
      openHowToPlay();
      setTimeout(() => {
        const button = document.getElementById('closehowto');
        if (button) {
          button.disabled = false;
          button.classList.add('button-enabled');
          console.log('Let\'s go button enabled');
        } else {
          console.error('Button with ID "closehowto" not found');
        }
      }, 5000);
    }
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XT4SMTQCY2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XT4SMTQCY2');
  </script>

  <body>
    <!-- Orientation Warning Overlay -->
    <div id="orientationOverlay" class="orientation-overlay hidden">
      <div class="orientation-content">
        <div class="orientation-icon">ðŸ“±</div>
        <h2>Please Rotate Your Device</h2>
        <p>Hold your device in portrait mode for the best experience</p>
      </div>
    </div>

    <video autoplay style="width: 100vw; height: 100vh; object-fit: cover;"></video>
    
    <!-- Underwater Water Filter Overlay -->
    <div id="waterFilter" class="water-filter"></div>
    
    <!-- Wave Effect -->
    <div id="wave" class="wave-effect"></div>
    
    <!-- Bubble Container -->
    <div id="bubbleContainer" class="bubble-container"></div>
    
    <!-- How to Play Overlay -->
    <div id="howToPlay" class="overlay hidden">
      <div class="popup-content">
        <header>
          <button class="back-button" onclick="backHowToPlay()">
            <img src="assets/Arrow.png" alt="Back">
          </button>
          <h1>How to Play</h1>
          <div class="header-placeholder"></div>
        </header>

        <main class="how-to-play">
          <!-- Instruction 1 -->
          <div class="instruction">
            <div class="instruction-icon">
              <img src="assets/icon-number.png" alt="Step 1" class="number-icon">
              <p class="instruction-text">In exchange for a home, clownfish keep anemones clean. Will you help clean the anemones?</p>
            </div>
            <img src="assets/anemone1.png" alt="Dirty Anemones" class="instruction-image">
          </div>

          <!-- Instruction 2 (Reversed layout) -->
          <div class="instruction reverse">
            <img src="assets/anemone2.png" alt="Scrub to clean" class="instruction-image">
            <div class="instruction-icon">
              <img src="assets/icon-number-2.png" alt="Step 2" class="number-icon">
              <p class="instruction-text">Rub the dirty spots of the anemone with your finger to clean them.</p>
            </div>
          </div>

          <!-- Instruction 3 -->
          <div class="instruction">
            <div class="instruction-icon">
              <img src="assets/icon-number-3.png" alt="Step 3" class="number-icon">
              <p class="instruction-text">Clean all four anemones to finish the job and help the clownfish thrive!</p>
            </div>
            <img src="assets/anemone3.png" alt="Clean all 4" class="instruction-image">
          </div>
        </main>

        <footer>
          <button id="closehowto" class="main-button" onclick="closeHowToPlay()" disabled>Let's Go</button>
        </footer>
      </div>
    </div>

    <!--   Game Complete   -->
    <div id="gamecomplete" class="popupWindow hidden" style="overflow: unset;">
      <div class="starRow">
        <img class="star" src="assets/Star.png">
        <img class="star" src="assets/Star.png">
        <img class="star" src="assets/Star.png">
      </div>
      <div class="popupContent" style="padding: 1rem 0rem 0rem 0rem;">
        <div style="width: 100%">
          <h2 class="amatic-sc-bold" style="margin: 0; font-size: 2.5rem;">Game Complete</h2>
          <hr style="width: 80%; border: none; background-color: #E7D4A3; color: #E7D4A3; height: 1px;">
        </div>
        <p style="font-size: 1.25rem; font-family: 'BentonSans Book', sans-serif;">The anemones are clean and the clownfish has a safe home!</p>
        <div class="buttonRow">
          <button class="secondaryButton popupButtonSmall" onclick="">
            <img src="assets/Share.png" style="object-fit: contain; width: 2rem;">
          </button>
          <button class="secondaryButton popupButtonSmall" onclick="restartGame()">
            <img src="assets/PlayAgain.png" style="object-fit: contain; width: 2rem;">
          </button>
          <button class="primaryButton popupButtonSmall" onclick="showBadgeCollection()" style="font-family: 'BentonSans', sans-serif;">Continue</button>
        </div>
      </div>
    </div>

    <!-- Badge Congratulations Splash (4s auto-dismiss) -->
    <div id="badgeSplash" class="badge-splash hidden">
      <div class="splash-content">
        <img src="../../assets/badges/icons/clownfish-game-badge.png" class="splash-badge-icon">
        <h1 class="splash-title">Congratulations</h1>
        <p class="splash-subtitle">You earned a badge!</p>
      </div>
    </div>

    <!-- Badge Collection Detail Screen -->
    <div id="badgeCollection" class="badge-collection hidden">
      <div class="badge-detail-content">
        <img src="../../assets/badges/icons/clownfish-game-badge.png" class="badge-detail-icon">
        <h2 class="badge-name">Careful Cleaner</h2>
        <p class="badge-description">Great care! You've scrubbed the anemones spotless for the Clownfish.</p>
        <button class="primaryButton" onclick="goHome()">Continue</button>
      </div>
    </div>
    
    <!-- HTML Overlay -->
    <div id="overlay" style="position: absolute; z-index: 10; ">
      <header>
        <button id="help" class="secondaryButton squareButton" onclick="openHowToPlay()" style="position: absolute; right: 4%; top: 2%; padding: 12px;">
          <img src="assets/Help.png" alt="Help" style="width: 24px; height: 24px; object-fit: contain;">
        </button>
        <p id="hint">Rub the anemones with your finger to clean them.</p>  
      </header>
      <div id="instructions" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); color: var(--Texts-textWhite, #FCEFE1); text-align: center; font-family: 'BentonSans'; font-size: clamp(18px, 4vw, 24px); font-style: normal; font-weight: 400; line-height: 1.2; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); opacity: 0; transition: opacity 1s ease-in-out; max-width: 90%;">
        Rub the anemones clean to<br>help the Clownfish thrive.
      </div>
    </div>

    <!-- Aframe Scene -->
    <a-scene id="scene" webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay;" button-enter-ar="buttonID: #arButton;"
    cursor="rayOrigin: mouse; fuse: false;" raycaster="objects: .raycast;"
    physics=" driver: ammo; debug: false; debugDrawMode: 1; iterations: 100; maxSubSteps: 4; fixedTimeStep: 0.01667"
    renderer="antialias: true; highRefreshRate: true; colorManagement: true; sortObjects: false; logarithmicDepthBuffer: false; physicallyCorrectLights: true; maxCanvasWidth: 1920; maxCanvasHeight: 1920; foveationLevel: 0;"
    gltf-model="dracoDecoderPath: https://cdn.jsdelivr.net/npm/three@0.129.0/examples/js/libs/draco/gltf/;">
      
      <!-- Assets -->
      <a-assets>
        <a-asset-item
          id="anemone-glb"
          src="assets/ClownfishAnemoneGame.glb"
        ></a-asset-item>

        <audio id="background-mp3" src="assets/audio/background.mp3" autostart="0" preload ="none"></audio>

        <audio id="cleaning1-mp3" src="assets/audio/cleaning1.mp3" autostart="0" preload ="none"></audio>
        <audio id="cleaning2-mp3" src="assets/audio/cleaning2.mp3" autostart="0" preload ="none"></audio>
        <audio id="cleaning3-mp3" src="assets/audio/cleaning3.mp3" autostart="0" preload ="none"></audio>
        <audio id="cleaned1-mp3" src="assets/audio/cleaned1.mp3" autostart="0" preload ="none"></audio>
        <audio id="cleaned2-mp3" src="assets/audio/cleaned2.mp3" autostart="0" preload ="none"></audio>
        <audio id="cleaned3-mp3" src="assets/audio/cleaned3.mp3" autostart="0" preload ="none"></audio>

        <audio id="click-mp3" src="assets/audio/click.mp3" autostart="0" preload ="none"></audio>
        <audio id="bling-mp3" src="assets/audio/bling.mp3" autostart="0" preload ="none"></audio>

        <audio id="ding-wav" src="assets/audio/ding.wav" autostart="0" preload ="none"></audio>
        <audio id="ding2-wav" src="assets/audio/ding2.wav" autostart="0" preload ="none"></audio>
        <audio id="tada-wav" src="assets/audio/tada.mp3" autostart="0" preload ="none"></audio>
        
        <img id="star-texture" src="assets/Star.png" crossorigin="anonymous">
        <img id="dirt1-texture" src="assets/dirt1.png" crossorigin="anonymous">
        <img id="dirt2-texture" src="assets/dirt2.png" crossorigin="anonymous">
        <img id="dirt3-texture" src="assets/dirt3.png" crossorigin="anonymous">
        <img id="bubble-texture" src="assets/bubble.png" crossorigin="anonymous">
      </a-assets>

      <!-- Camera -->
      <a-entity id="camera" position="0 1.15 0" rotation="0 0 0" camera="near: 0.0001; far: 1000;" look-controls="magicWindowTrackingEnabled: true; touchEnabled: false;">
          <!--     Place objects attached to camera here     -->
      </a-entity>
      
      <!-- Light & Sound -->
      <a-entity light="type: ambient; color: #fff; intensity: 2;"></a-entity>
      <a-entity id="background-sfx" sound="src: #background-mp3; on: startsound; loop: true; volume: 0.75;"></a-entity>

      <a-entity id="click-sfx" sound="src: #click-mp3; on: startsound; loop: false; volume: 2;"></a-entity>
      <a-entity id="tada-sfx" sound="src: #tada-wav; on: startsound; loop: false; volume: 1;"></a-entity>

      <a-entity id="cleaning-sfx-1" sound="src: #cleaning1-mp3; on: startsound; loop: false; volume: 2; poolSize: 2;"></a-entity>
      <a-entity id="cleaning-sfx-2" sound="src: #cleaning2-mp3; on: startsound; loop: false; volume: 2; poolSize: 2;"></a-entity>
      <a-entity id="cleaning-sfx-3" sound="src: #cleaning3-mp3; on: startsound; loop: false; volume: 2; poolSize: 2;"></a-entity>
      <a-entity id="cleaned-sfx-1" sound="src: #cleaned1-mp3; on: startsound; loop: false; volume: 2; poolSize: 2;"></a-entity>
      <a-entity id="cleaned-sfx-2" sound="src: #cleaned2-mp3; on: startsound; loop: false; volume: 2; poolSize: 2;"></a-entity>
      <a-entity id="cleaned-sfx-3" sound="src: #cleaned3-mp3; on: startsound; loop: false; volume: 2; poolSize: 2;"></a-entity>
      
      <!-- Scene contents -->
      <a-entity id="floor" position="0 -0.5 0" geometry="primitive: cylinder; radius: 50; height: 1;" visible="false" grip="0.9" material="color: lime;"
      ammo-body="type: static;" ammo-shape="type: cylinder;"></a-entity>
      
      <a-entity id="anemone" gltf-model="#anemone-glb" position="0 0 -1.5" rotation="0 -90 0" scale="10 10 10" 
        animation-mixer="clip: *;" zone-textures no-culling></a-entity>
      
      <!-- Particle effect entities for each cleaning zone -->
      <a-entity id="particle-a" particle-effects="zone: a; position: -0.7 0.5 -1.5"></a-entity>
      <a-entity id="particle-b" particle-effects="zone: b; position: -0.2 0.5 -1.3"></a-entity>
      <a-entity id="particle-c" particle-effects="zone: c; position: 0.35 0.5 -1.5"></a-entity>
      <a-entity id="particle-d" particle-effects="zone: d; position: 0.85 0.5 -1.4"></a-entity>

      <a-entity id="dirt1" position="-0.7 0.5 -1.5" geometry="primitive: cylinder; radius: 0.2; height: 0.75;" material="color: brown" visible="false"
        scrubbable="milestone1Value: 1; milestone2Value: 33; milestone3Value: 66; finishedValue: 100;"
        animation__shrink1="property: scale; to: 0.85 0.85 0.85; startEvents: milestone1; dur: 750"
        animation__shrink2="property: scale; to: 0.7 0.7 0.7; startEvents: milestone2; dur: 750"
        animation__shrink3="property: scale; to: 0.5 0.5 0.5; startEvents: milestone3; dur: 750"
        animation__shrink4="property: scale; to: 0 0 0; startEvents: finished; dur: 750"></a-entity>
      <a-entity id="dirt2" position="-0.2 0.5 -1.3" geometry="primitive: cylinder; radius: 0.2; height: 0.75;" material="color: brown" visible="false"
        scrubbable="milestone1Value: 1; milestone2Value: 33; milestone3Value: 66; finishedValue: 100;"
        animation__shrink1="property: scale; to: 0.85 0.85 0.85; startEvents: milestone1; dur: 750"
        animation__shrink2="property: scale; to: 0.7 0.7 0.7; startEvents: milestone2; dur: 750"
        animation__shrink3="property: scale; to: 0.5 0.5 0.5; startEvents: milestone3; dur: 750"
        animation__shrink4="property: scale; to: 0 0 0; startEvents: finished; dur: 750"></a-entity>
      <a-entity id="dirt3" position="0.35 0.5 -1.5" geometry="primitive: cylinder; radius: 0.2; height: 0.75;" material="color: brown" visible="false"
        scrubbable="milestone1Value: 1; milestone2Value: 33; milestone3Value: 66; finishedValue: 100;"
        animation__shrink1="property: scale; to: 0.85 0.85 0.85; startEvents: milestone1; dur: 750"
        animation__shrink2="property: scale; to: 0.7 0.7 0.7; startEvents: milestone2; dur: 750"
        animation__shrink3="property: scale; to: 0.5 0.5 0.5; startEvents: milestone3; dur: 750"
        animation__shrink4="property: scale; to: 0 0 0; startEvents: finished; dur: 750"></a-entity>
      <a-entity id="dirt4" position="0.85 0.5 -1.4" geometry="primitive: cylinder; radius: 0.2; height: 0.75;" material="color: brown" visible="false"
        scrubbable="milestone1Value: 1; milestone2Value: 33; milestone3Value: 66; finishedValue: 100;"
        animation__shrink1="property: scale; to: 0.85 0.85 0.85; startEvents: milestone1; dur: 750"
        animation__shrink2="property: scale; to: 0.7 0.7 0.7; startEvents: milestone2; dur: 750"
        animation__shrink3="property: scale; to: 0.5 0.5 0.5; startEvents: milestone3; dur: 750"
        animation__shrink4="property: scale; to: 0 0 0; startEvents: finished; dur: 750"></a-entity>
      
      <!-- Hand scrubbing animation for zone 2 -->
      <a-entity id="hand-guide" position="-0.2 0.5 -1.0" visible="true">
        <a-plane id="hand-image" 
          src="assets/Hand.png" 
          width="0.4" 
          height="0.4" 
          position="0 0 0.2"
          material="transparent: true; opacity: 0.9"
          animation__scrub="property: position; to: 0.15 0.15 0.2; dur: 600; loop: true; dir: alternate; easing: easeInOutSine"
          animation__fade="property: material.opacity; to: 0; dur: 1000; startEvents: zone2Finished; delay: 500"></a-plane>
      </a-entity>
      
    </a-scene>
  </body>

  <script src="main.js"></script>
</html>