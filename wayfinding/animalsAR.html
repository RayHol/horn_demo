<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        (function(){
            try {
                var granted = localStorage.getItem('geopin-location-permission') === 'granted';
                if (!granted) {
                    // Best-effort: if Permissions API is available and already granted, set flag
                    if (navigator.permissions && navigator.permissions.query) {
                        navigator.permissions.query({ name: 'geolocation' }).then(function(p){
                            if (p.state === 'granted') {
                                try { localStorage.setItem('geopin-location-permission','granted'); } catch(_) {}
                            } else {
                                window.location.replace('./index.html');
                            }
                        }).catch(function(){ window.location.replace('./index.html'); });
                    } else {
                        window.location.replace('./index.html');
                    }
                }
            } catch (_) { /* if storage blocked, just continue */ }
        })();
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, height=device-height, minimum-scale=1, maximum-scale=1, initial-scale=1, user-scalable=no, user-scalable=0"/>
    <title>Geo-AnimalsAR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script type='text/javascript' src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/3.4.7/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script>
        THREEx.ArToolkitContext.baseURL = 'https://raw.githack.com/jeromeetienne/ar.js/master/three.js/'
    </script>
    <script src="../customer-io-helper.js"></script>
    <script src="./scripts/script.js"></script>
    <link rel="stylesheet" type="text/css" href="./scripts/style.css"/>
    <style>
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden; background: var(--Background-main);'>
    <!-- AR Overlay -->
    <div class="ar-overlay">
        <div class="ar-overlay__background"></div>
        <div class="ar-overlay__cutout" id="arCutout">
            <!-- Corner graphics -->
            <img src="./assets/ui/corner-path.svg" alt="" class="ar-corner ar-corner--top-left">
            <img src="./assets/ui/corner-path.svg" alt="" class="ar-corner ar-corner--top-right">
            <img src="./assets/ui/corner-path.svg" alt="" class="ar-corner ar-corner--bottom-left">
            <img src="./assets/ui/corner-path.svg" alt="" class="ar-corner ar-corner--bottom-right">
        </div>
        <a href="./wayfinding.html" class="ar-overlay__back-button" aria-label="Back to wayfinding page"></a>
        <div class="ar-overlay__title">FIND THE ANIMALS</div>
        <div class="centered instructions"></div>
    </div>
    <a-scene 
        xr-mode-ui='enabled: false' 
        embedded
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;'>
    <a-camera id="mainCamera" gps-camera rotation-reader raycaster="objects: .detectable, .detectable *; interval: 200; far: 1000"></a-camera>
    
    <!-- Lighting -->
    <!-- Ambient light for general scene illumination -->
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.2;"></a-entity>
    
    <!-- Directional light to simulate sunlight and add depth -->
    <!-- <a-entity light="type: directional; color: #ffffff; intensity: 1; position: 1 3 2;"></a-entity> -->
    
    <!-- Note: Light estimation would require WebXR (not available with AR.js marker-based AR) -->
    <a-entity light-estimation></a-entity>
</a-scene>
<div class="centered">
    <button data-action="camera-btn" title="Camera action" aria-label="Camera action"></button>
</div>
<div class="centered centered--debug">
    <div id="proximityDebug" style="font-size: 0.9em; color: var(--Texts-textWhite); text-align: center; font-family: 'BentonSans Book', sans-serif;"></div>
</div>
<!-- Badge Congratulations Splash (4s auto-dismiss) -->
<div id="badgeSplash" class="badge-splash hidden">
  <div class="starburst-background-overlay"></div>
  <div class="splash-content">
    <img id="badgeSplashIcon" src="" class="splash-badge-icon">
    <h1 class="splash-title">Congratulations</h1>
    <p class="splash-subtitle">You earned a badge!</p>
  </div>
</div>

<!-- Badge Collection Detail Screen -->
<div id="badgeCollection" class="badge-collection hidden">
  <div class="starburst-background-overlay"></div>
  <div class="badge-detail-content">
    <img id="badgeDetailIcon" src="" class="badge-detail-icon">
    <h2 id="badgeDetailName" class="badge-name"></h2>
    <p id="badgeDetailDescription" class="badge-description"></p>
    <div class="badge-buttons">
      <button id="playGameButton" class="secondaryButton" onclick="playGame()" style="display: none;">Play Game</button>
      <button class="primaryButton" onclick="goHome()">Back to the map</button>
    </div>
  </div>
</div>

<div class="loader-overlay" id="sceneLoader">
    <div class="loader"></div>
    
</div>
<audio id="tada-audio" src="../games/anemone-cleaning/assets/audio/tada.mp3" preload="auto"></audio>
</body>

</html>

