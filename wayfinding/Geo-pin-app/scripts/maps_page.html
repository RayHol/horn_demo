<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoPin Maps - Set Pins Visually</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        /* Ensure link buttons have no underlines */
        a.btn {
            text-decoration: none;
        }

        a.btn:hover {
            text-decoration: none;
        }

        /* Ensure all button links have no underlines */
        a[class*="btn"] {
            text-decoration: none !important;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .map-container {
            height: calc(100vh - 70px);
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 500;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .instructions p {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .instructions .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .pin-form {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            max-height: calc(100vh - 160px);
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 500;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .pin-form.active {
            transform: translateY(0);
            opacity: 1;
        }

        .instructions-panel {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            max-height: calc(100vh - 160px);
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 500;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .instructions-panel.active {
            transform: translateY(0);
            opacity: 1;
        }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .instructions-header h3 {
            color: #333;
            margin: 0;
            font-size: 1.2rem;
        }

        .instructions-content p {
            color: #555;
            line-height: 1.6;
            margin: 0;
        }

        .pin-form h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            /* Prevent iOS zoom on focus */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            transform-origin: left top;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 50px;
        }

        .coordinates {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            flex: 0 0 auto;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .current-location-btn {
            position: absolute;
            bottom: 60px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 500;
            transition: all 0.3s ease;
        }

        .current-location-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .help-btn {
            position: absolute;
            bottom: 180px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #667eea;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 500;
            transition: all 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .help-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .help-btn.active {
            background: #667eea;
            color: white;
        }

        .draggable-pin {
            position: absolute;
            bottom: 120px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #667eea;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 500;
            transition: all 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .draggable-pin:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .draggable-pin.active {
            background: #667eea;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            z-index: 1000;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-weight: 500;
            animation: slideIn 0.4s ease;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .alert-notification {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-notification {
            background: white;
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .instructions {
                left: 10px;
                right: 10px;
            }
            
            .pin-form {
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .current-location-btn {
                left: 20px;
                bottom: 60px;
            }
            
            .help-btn {
                left: 20px;
                bottom: 180px;
            }
            
            .draggable-pin {
                left: 20px;
                bottom: 120px;
            }
            
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìçGeoPin</h1>
        <div class="header-controls">
            <a href="geo_pin.html" class="btn btn-secondary">üéØ View Pins</a>
            <a href="../animalsAR.html" class="btn btn-secondary">üè† Home</a>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading Google Maps...</p>
    </div>



    <div class="map-container">
        <div id="map"></div>
        
        <button class="current-location-btn" onclick="goToCurrentLocation()" title="Go to my location">
            üìç
        </button>
        
        <div class="help-btn" id="helpBtn" title="Show instructions">
            ‚ùì
        </div>
        
        <div class="draggable-pin" id="draggablePin" title="Click to activate pin placement">
            üìå
        </div>
        
        <div class="pin-form" id="pinForm">
            <h3>üéØ Add New Pin</h3>
            <div class="coordinates" id="coordinates"></div>
            
            <div class="form-group">
                <label for="pinName">Pin Name</label>
                <input type="text" id="pinName" placeholder="e.g., Home, Office, Store">
            </div>

            <div class="form-group">
                <label for="pinDescription">Description (optional)</label>
                <textarea id="pinDescription" placeholder="Add a note or reminder"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="altitude">Altitude (m)</label>
                    <input type="number" id="altitude" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="radius">Alert Radius (m)</label>
                    <input type="number" id="radius" value="10" min="1" max="10000">
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="savePin()">üíæ Save Pin</button>
                <button class="btn btn-cancel" onclick="cancelPin()">‚ùå</button>
            </div>
        </div>

        <div class="instructions-panel" id="instructionsPanel">
            <div class="instructions-header">
                <h3>üìç How to Add Pins</h3>
                <button class="close-btn" onclick="closeInstructions()">√ó</button>
            </div>
            <div class="instructions-content">
                <p><strong>Click the üìå pin button</strong> to activate pin placement mode, then click anywhere on the map to place a pin. The button will turn orange when active. You can then add a name, description, and set an alert radius for your pin.</p>
            </div>
        </div>
    </div>

    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlOJ1c7SRN16w8gv4fubP7bYkJ6iNb_Po&callback=initMap">
    </script>

    <script>
        let map;
        let currentMarker;
        let selectedLocation = null;
        let userLocation = null;
        let notificationSound = null;

        // Initialize notification sound
        function initNotificationSound() {
            try {
                notificationSound = new Audio('../assets/bell.mp3');
                notificationSound.volume = 0.5; // Set volume to 50%
            } catch (error) {
                console.log('Could not load notification sound:', error);
            }
        }

        // Auto-start location tracking if permission is granted
        async function autoStartLocationTracking() {
            if (!navigator.geolocation) {
                return;
            }

            // Check if we have stored permission
            const storedPermission = localStorage.getItem('geopin-location-permission');
            
            if (storedPermission === 'granted') {
                // Permission was granted before, start tracking without checking again
                navigator.geolocation.watchPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        // Update map center if not already centered on user
                        if (map && !map.getCenter().equals(new google.maps.LatLng(userLocation.lat, userLocation.lng))) {
                            map.setCenter(userLocation);
                        }
                    },
                    (error) => {
                        console.log("Location tracking error:", error);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
                );
                return;
            }

            // iOS Safari workaround - try to get position directly
            // This avoids permission API issues on iOS
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Permission granted, store it and start tracking
                    localStorage.setItem('geopin-location-permission', 'granted');
                    navigator.geolocation.watchPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            // Update map center if not already centered on user
                            if (map && !map.getCenter().equals(new google.maps.LatLng(userLocation.lat, userLocation.lng))) {
                                map.setCenter(userLocation);
                            }
                        },
                        (error) => {
                            console.log("Location tracking error:", error);
                        },
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
                    );
                },
                function(error) {
                    // Permission not granted, don't auto-start
                    console.log('Location permission not granted, manual start required');
                },
                { 
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                }
            );
        }

        // Initialize Google Maps
        function initMap() {
            // Default to London if geolocation fails
            const defaultLocation = { lat: 51.5074, lng: -0.1278 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: defaultLocation,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ],
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true
            });

            // Try to get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(userLocation);
                        
                        // Add a marker for current location
                        new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: "Your Current Location",
                            icon: {
                                url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iOCIgZmlsbD0iIzQyODVmNCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
                                scaledSize: new google.maps.Size(24, 24),
                                anchor: new google.maps.Point(12, 12)
                            }
                        });
                    },
                    (error) => {
                        console.log("Geolocation error:", error);
                        showNotification("Could not get your location. Using default location.");
                    }
                );
            }

            // Add click-based pin placement
            const draggablePin = document.getElementById('draggablePin');
            const helpBtn = document.getElementById('helpBtn');
            let isPinModeActive = false;

            // Click help button to show instructions
            helpBtn.addEventListener('click', () => {
                showInstructions();
                helpBtn.classList.add('active');
            });

            // Click pin button to activate pin placement mode
            draggablePin.addEventListener('click', () => {
                isPinModeActive = !isPinModeActive;
                if (isPinModeActive) {
                    draggablePin.classList.add('active');
                    showInfoNotification('üìç Click anywhere on the map to place a pin');
                } else {
                    draggablePin.classList.remove('active');
                    showInfoNotification('üìç Pin placement mode deactivated');
                }
            });

            // Click on map to place pin when in pin mode
            map.addListener('click', (e) => {
                if (isPinModeActive) {
                    placePin(e.latLng);
                    isPinModeActive = false;
                    draggablePin.classList.remove('active');
                    showInfoNotification('üìç Pin placed! Add details below to save.');
                }
            });

            hideLoading();
        }

        // Place a pin on the map
        function placePin(latLng) {
            // Remove existing marker if any
            if (currentMarker) {
                currentMarker.setMap(null);
            }

            // Create new marker
            currentMarker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: "New Pin Location",
                icon: {
                    url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDlDNSAxNC4yNSAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxNC4yNSAxOSA5QzE5IDUuMTMgMTUuODcgMiAxMiAyWk0xMiAxMS41QzEwLjYyIDExLjUgOS41IDEwLjM4IDkuNSA5QzkuNSA3LjYyIDEwLjYyIDYuNSAxMiA2LjVDMTMuMzggNi41IDE0LjUgNy42MiAxNC41IDlDMTQuNSAxMC4zOCAxMy4zOCAxMS41IDEyIDExLjVaIiBmaWxsPSIjZmY0NDQ0Ii8+Cjwvc3ZnPgo=',
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 32)
                },
                animation: google.maps.Animation.DROP
            });

            // Store the selected location
            selectedLocation = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };

            // Update coordinates display
            document.getElementById('coordinates').textContent = 
                `üìç ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;

            // Show the pin form
            document.getElementById('pinForm').classList.add('active');
            
            // Clear previous form data
            document.getElementById('pinName').value = '';
            document.getElementById('pinDescription').value = '';
            document.getElementById('altitude').value = '';
            document.getElementById('radius').value = '10';

            // Focus on the name input for better UX
            setTimeout(() => {
                const nameInput = document.getElementById('pinName');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);

            showInfoNotification('üìç Pin placed! Add details below to save.');
        }

        // Go to current location
        function goToCurrentLocation() {
            if (userLocation) {
                map.setCenter(userLocation);
                map.setZoom(15);
            } else if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(userLocation);
                        map.setZoom(15);
                        showInfoNotification('üìç Centered on your location');
                    },
                    (error) => {
                        showInfoNotification('‚ùå Unable to get your location');
                    }
                );
            } else {
                showInfoNotification('‚ùå Geolocation not supported');
            }
        }

        // Save pin to localStorage
        function savePin() {
            const name = document.getElementById('pinName').value.trim();
            const description = document.getElementById('pinDescription').value.trim();
            const altitude = parseFloat(document.getElementById('altitude').value) || 0;
            const radius = parseInt(document.getElementById('radius').value);

            if (!name) {
                showInfoNotification('‚ùå Please enter a pin name');
                return;
            }

            if (!selectedLocation) {
                showInfoNotification('‚ùå No location selected');
                return;
            }

            if (radius < 10 || radius > 10000) {
                showInfoNotification('‚ùå Radius must be between 10 and 10,000 meters');
                return;
            }

            // Create pin object
            const pin = {
                id: Date.now(),
                name,
                description,
                latitude: selectedLocation.lat,
                longitude: selectedLocation.lng,
                altitude,
                radius,
                triggered: false,
                created: new Date().toISOString()
            };

            // Save to localStorage (same format as main app)
            let pins = [];
            const saved = localStorage.getItem('geopin-pins');
            if (saved) {
                pins = JSON.parse(saved);
            }
            pins.push(pin);
            localStorage.setItem('geopin-pins', JSON.stringify(pins));

            // Update marker to show it's saved
            if (currentMarker) {
                currentMarker.setIcon({
                    url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDlDNSAxNC4yNSAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxNC4yNSAxOSA5QzE5IDUuMTMgMTUuODcgMiAxMiAyWk0xMiAxMS41QzEwLjYyIDExLjUgOS41IDEwLjM4IDkuNSA5QzkuNSA3LjYyIDEwLjYyIDYuNSAxMiA2LjVDMTMuMzggNi41IDE0LjUgNy42MiAxNC41IDlDMTQuNSAxMC4zOCAxMy4zOCAxMS41IDEyIDExLjVaIiBmaWxsPSIjNjY3ZWVhIi8+Cjwvc3ZnPgo=',
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 32)
                });
                currentMarker.setTitle(`${name} - Saved!`);
            }

            // Hide form and show success
            document.getElementById('pinForm').classList.remove('active');
            showInfoNotification(`‚úÖ Pin "${name}" saved successfully!`);
            
            // Reset for next pin
            selectedLocation = null;
            setTimeout(() => {
                if (currentMarker) {
                    currentMarker.setMap(null);
                    currentMarker = null;
                }
            }, 2000);
        }

        // Cancel pin placement
        function cancelPin() {
            document.getElementById('pinForm').classList.remove('active');
            if (currentMarker) {
                currentMarker.setMap(null);
                currentMarker = null;
            }
            selectedLocation = null;
        }

        // Show instructions panel
        function showInstructions() {
            document.getElementById('instructionsPanel').classList.add('active');
        }

        // Close instructions panel
        function closeInstructions() {
            document.getElementById('instructionsPanel').classList.remove('active');
            document.getElementById('helpBtn').classList.remove('active');
        }

        // Show alert notification (blue with sound - for proximity alerts)
        function showAlertNotification(message) {
            // Play notification sound for alert messages
            if (notificationSound) {
                notificationSound.play().catch(error => {
                    console.log('Could not play notification sound:', error);
                });
            }

            // Trigger vibration on mobile devices for alert messages
            if ('vibrate' in navigator) {
                // Vibration pattern: short-long-short (like a notification)
                navigator.vibrate([100, 200, 100]);
            }

            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification alert-notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show info notification (white without sound - for general info)
        function showInfoNotification(message) {
            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification info-notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Legacy function for backward compatibility
        function showNotification(message) {
            showInfoNotification(message);
        }

        // Hide loading screen
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Handle API key error
        window.gm_authFailure = function() {
            hideLoading();
            document.getElementById('map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; color: #666; flex-direction: column; text-align: center; padding: 20px;">
                    <h2>üó∫Ô∏è Google Maps API Key Required</h2>
                    <p style="margin: 20px 0; line-height: 1.6;">
                        To use the maps feature, you need to add a Google Maps API key.<br>
                    </p>
                    <p style="color: #999; font-size: 14px;">
                        Get your API key at: <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank" style="color: #667eea;">Google Maps Platform</a>
                    </p>
                </div>
            `;
        };

        // Load existing pins on map
        function loadExistingPins() {
            const saved = localStorage.getItem('geopin-pins');
            if (!saved) return;

            const pins = JSON.parse(saved);
            pins.forEach(pin => {
                new google.maps.Marker({
                    position: { lat: pin.latitude, lng: pin.longitude },
                    map: map,
                    title: pin.name,
                    icon: {
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDlDNSAxNC4yNSAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxNC4yNSAxOSA5QzE5IDUuMTMgMTUuODcgMiAxMiAyWk0xMiAxMS41QzEwLjYyIDExLjUgOS41IDEwLjM4IDkuNSA5QzkuNSA3LjYyIDEwLjYyIDYuNSAxMiA2LjVDMTMuMzggNi41IDE0LjUgNy42MiAxNC41IDlDMTQuNSAxMC4zOCAxMy4zOCAxMS41IDEyIDExLjVaIiBmaWxsPSIjNjY3ZWVhIi8+Cjwvc3ZnPg==',
                        scaledSize: new google.maps.Size(24, 24),
                        anchor: new google.maps.Point(12, 24)
                    }
                });
            });
        }

                    // Load existing pins after map loads
            if (typeof google !== 'undefined') {
                google.maps.event.addListenerOnce(map, 'tilesloaded', loadExistingPins);
            }

            // Auto-start location tracking if permission is granted
            autoStartLocationTracking();
            
            // Initialize notification sound
            initNotificationSound();
    </script>
</body>
</html>