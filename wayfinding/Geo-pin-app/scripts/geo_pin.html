<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoPin - Location Notifications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            text-decoration: none;
            display: inline-block;
        }

        /* Ensure link buttons have no underlines */
        a.btn {
            text-decoration: none;
        }

        a.btn:hover {
            text-decoration: none;
        }

        /* Ensure all button links have no underlines */
        a[class*="btn"] {
            text-decoration: none !important;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .status.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .pin-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .pin-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .pin-item .pin-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .pin-item .distance {
            font-weight: 600;
            color: #667eea;
        }

        .pin-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        /* Remove underlines from link buttons */
        a.btn {
            text-decoration: none;
            display: inline-block;
        }

        a.btn:hover {
            text-decoration: none;
        }

        /* Ensure all button links have no underlines */
        a[class*="btn"] {
            text-decoration: none !important;
        }

        /* Header buttons should be compact, not full-width */
        .header .btn {
            width: auto;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 0;
        }

        /* Content secondary buttons should have gradient background */
        .card .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
        }

        .card .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.3);
        }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.4s ease;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .location-info {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìçGeoPin</h1>
        <div class="header-controls">
            <a href="maps_page.html" class="btn btn-secondary">üó∫Ô∏è Maps</a>
            <a href="../animalsAR.html" class="btn btn-secondary">üè† Home</a>
        </div>
    </div>

    <div class="container">

        <div class="card">
            <h3 style="margin-bottom: 20px; color: #333;">üéØ Location Control</h3>
            
            <button id="locationBtn" class="btn btn-success" onclick="toggleLocationTracking()">
                üåç Enable Location Tracking
            </button>

            <div class="location-info" id="locationInfo">
                Location tracking disabled
            </div>
        </div>

        <div id="status" class="status warning">
            Click "Enable Location" to get started
        </div>

        <div class="card">
            <a href="maps_page.html" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center;">
                üìç Add pin on the map
            </a>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px; color: #333;">üìç Add New Pin</h3>
            
            <div class="form-group">
                <label for="pinName">Pin Name</label>
                <input type="text" id="pinName" placeholder="e.g., Home, Office, Store">
            </div>

            <div class="form-group">
                <label for="pinDescription">Description (optional)</label>
                <textarea id="pinDescription" placeholder="Add a note or reminder"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" id="latitude" step="any" placeholder="0.000000">
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" id="longitude" step="any" placeholder="0.000000">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="altitude">Altitude (m)</label>
                    <input type="number" id="altitude" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="radius">Radius (m)</label>
                    <input type="number" id="radius" value="10" min="1" max="10000">
                </div>
            </div>

            <button class="btn btn-secondary" onclick="useCurrentLocation()">
                üì± Use Current Location
            </button>
            
            <button class="btn btn-primary" onclick="addPin()">
                ‚ûï Add Pin
            </button>
        </div>

        <div class="card" id="pinsCard" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #333;">üìå Your Pins</h3>
            <div id="pinsList"></div>
        </div>
    </div>

    <script>
        let watchId = null;
        let pins = [];
        let currentPosition = null;
        let notificationPermission = false;
        let notificationSound = null;

        // Initialize notification sound
        function initNotificationSound() {
            try {
                notificationSound = new Audio('../assets/bell.mp3');
                notificationSound.volume = 0.5; // Set volume to 50%
                
                // Add event listeners to debug audio loading
                notificationSound.addEventListener('canplaythrough', () => {
                    console.log('Notification sound loaded successfully');
                });
                
                notificationSound.addEventListener('error', (e) => {
                    console.log('Error loading notification sound:', e);
                });
            } catch (error) {
                console.log('Could not load notification sound:', error);
            }
        }

        // Initialize app
        window.addEventListener('load', function() {
            loadPins();
            requestNotificationPermission();
            updatePinsList();
            autoStartLocationTracking();
            initNotificationSound();
        });

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === 'granted';
                
                if (!notificationPermission) {
                    showStatus('Please enable notifications for proximity alerts', 'warning');
                }
            }
        }

        // Auto-start location tracking if permission is granted
        async function autoStartLocationTracking() {
            if (!navigator.geolocation) {
                return;
            }

            // Check if we have stored permission
            const storedPermission = localStorage.getItem('geopin-location-permission');
            
            if (storedPermission === 'granted') {
                // Permission was granted before, start tracking without checking again
                startLocationTracking();
                return;
            }

            // iOS Safari workaround - try to get position directly
            // This avoids permission API issues on iOS
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Permission granted, store it and start tracking
                    localStorage.setItem('geopin-location-permission', 'granted');
                    startLocationTracking();
                },
                function(error) {
                    // Permission not granted, don't auto-start
                    console.log('Location permission not granted, manual start required');
                    if (error.code === error.PERMISSION_DENIED) {
                        showStatus('Location access denied. Please enable location services in Safari Settings.', 'warning');
                    }
                },
                { 
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );
        }

        // Toggle location tracking
        function toggleLocationTracking() {
            if (watchId === null) {
                startLocationTracking();
            } else {
                stopLocationTracking();
            }
        }

        // Start location tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showStatus('Geolocation not supported by this browser', 'error');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };

            watchId = navigator.geolocation.watchPosition(
                onLocationSuccess,
                onLocationError,
                options
            );

            // Store permission when manually enabled
            localStorage.setItem('geopin-location-permission', 'granted');

            document.getElementById('locationBtn').textContent = '‚èπÔ∏è Stop Location Tracking';
            document.getElementById('locationBtn').className = 'btn btn-danger';
            showStatus('Location tracking active', 'success');
        }

        // Stop location tracking
        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            document.getElementById('locationBtn').textContent = 'üåç Enable Location Tracking';
            document.getElementById('locationBtn').className = 'btn btn-success';
            document.getElementById('locationInfo').textContent = 'Location tracking disabled';
            showStatus('Location tracking stopped', 'warning');
        }

        // Clear stored permission (for testing)
        function clearLocationPermission() {
            localStorage.removeItem('geopin-location-permission');
            console.log('Location permission cleared');
        }

        // Location success callback
        function onLocationSuccess(position) {
            currentPosition = position;
            const { latitude, longitude, altitude } = position.coords;
            const accuracy = position.coords.accuracy;

            document.getElementById('locationInfo').innerHTML = `
                üìç Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}<br>
                üéØ Accuracy: ${Math.round(accuracy)}m
                ${altitude ? `| üèîÔ∏è Alt: ${Math.round(altitude)}m` : ''}
            `;

            checkProximityToAllPins();
            updatePinsList();
        }

        // Location error callback
        function onLocationError(error) {
            let message = 'Unable to get location';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied by user';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out';
                    break;
            }
            showStatus(message, 'error');
        }

        // Use current location for new pin
        function useCurrentLocation() {
            if (!currentPosition) {
                showStatus('Current location not available. Enable location tracking first.', 'warning');
                return;
            }

            const { latitude, longitude, altitude } = currentPosition.coords;
            document.getElementById('latitude').value = latitude;
            document.getElementById('longitude').value = longitude;
            document.getElementById('altitude').value = altitude ? Math.round(altitude) : 0;
        }

        // Add new pin
        function addPin() {
            const name = document.getElementById('pinName').value.trim();
            const description = document.getElementById('pinDescription').value.trim();
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const altitude = parseFloat(document.getElementById('altitude').value) || 0;
            const radius = parseInt(document.getElementById('radius').value);

            if (!name) {
                showStatus('Please enter a pin name', 'error');
                return;
            }

            if (isNaN(latitude) || isNaN(longitude)) {
                showStatus('Please enter valid coordinates', 'error');
                return;
            }

            if (radius < 10 || radius > 10000) {
                showStatus('Radius must be between 10 and 10,000 meters', 'error');
                return;
            }

            const pin = {
                id: Date.now(),
                name,
                description,
                latitude,
                longitude,
                altitude,
                radius,
                triggered: false,
                created: new Date().toISOString()
            };

            pins.push(pin);
            savePins();
            updatePinsList();
            clearForm();
            showStatus(`Pin "${name}" added successfully!`, 'success');
        }

        // Clear form
        function clearForm() {
            document.getElementById('pinName').value = '';
            document.getElementById('pinDescription').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('altitude').value = '';
            document.getElementById('radius').value = '100';
        }

        // Remove pin
        function removePin(id) {
            pins = pins.filter(pin => pin.id !== id);
            savePins();
            updatePinsList();
            showStatus('Pin removed', 'success');
        }

        // Calculate distance between two points using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Check proximity to all pins
        function checkProximityToAllPins() {
            if (!currentPosition) return;

            const userLat = currentPosition.coords.latitude;
            const userLon = currentPosition.coords.longitude;

            pins.forEach(pin => {
                const distance = calculateDistance(userLat, userLon, pin.latitude, pin.longitude);
                
                if (distance <= pin.radius && !pin.triggered) {
                    pin.triggered = true;
                    showNotification(pin);
                    savePins();
                } else if (distance > pin.radius && pin.triggered) {
                    // Reset trigger when user moves away
                    pin.triggered = false;
                    savePins();
                }
            });
        }

        // Show notification
        function showNotification(pin) {
            const message = `You're near "${pin.name}"${pin.description ? ': ' + pin.description : ''}`;
            
            // Play notification sound
            if (notificationSound) {
                console.log('Attempting to play notification sound...');
                notificationSound.play().catch(error => {
                    console.log('Could not play notification sound:', error);
                });
            } else {
                console.log('Notification sound not loaded');
            }
            
            // Trigger vibration on mobile devices
            if ('vibrate' in navigator) {
                // Vibration pattern: short-long-short (like a notification)
                navigator.vibrate([100, 200, 100]);
            }
            
            // Browser notification
            if (notificationPermission && 'Notification' in window) {
                new Notification('üìç GeoPin Alert', {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSIxNiIgeT0iMTYiPgo8cGF0aCBkPSJNMTIgMkM4LjEzIDIgNSA1LjEzIDUgOUM1IDEwLjc0IDUuNSAxMi4zNyA2LjM5IDEzLjc0TDEyIDIyTDE3LjYxIDEzLjc0QzE4LjUgMTIuMzcgMTkgMTAuNzQgMTkgOUMxOSA1LjEzIDE1Ljg3IDIgMTIgMlpNMTIgMTEuNUMxMC42MiAxMS41IDkuNSAxMC4zOCA5LjUgOUM5LjUgNy42MiAxMC42MiA2LjUgMTIgNi41QzEzLjM4IDYuNSAxNC41IDcuNjIgMTQuNSA5QzE0LjUgMTAuMzggMTMuMzggMTEuNSAxMiAxMS41WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo=',
                    tag: 'geopin-' + pin.id
                });
            }

            // In-app notification
            showInAppNotification(message);
        }

        // Show in-app notification
        function showInAppNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">üìç Location Alert!</div>
                <div>${message}</div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Update pins list
        function updatePinsList() {
            const pinsList = document.getElementById('pinsList');
            const pinsCard = document.getElementById('pinsCard');

            if (pins.length === 0) {
                pinsCard.style.display = 'none';
                return;
            }

            pinsCard.style.display = 'block';

            pinsList.innerHTML = pins.map(pin => {
                let distanceText = 'Distance unknown';
                if (currentPosition) {
                    const distance = calculateDistance(
                        currentPosition.coords.latitude,
                        currentPosition.coords.longitude,
                        pin.latitude,
                        pin.longitude
                    );
                    distanceText = `${Math.round(distance)}m away`;
                    if (distance <= pin.radius) {
                        distanceText += ' (NEARBY!)';
                    }
                }

                return `
                    <div class="pin-item">
                        <h4>${pin.name} ${pin.triggered ? 'üéØ' : 'üìç'}</h4>
                        <div class="pin-details">
                            ${pin.description ? pin.description + '<br>' : ''}
                            üìç ${pin.latitude.toFixed(6)}, ${pin.longitude.toFixed(6)}<br>
                            üéØ Alert radius: ${pin.radius}m | üèîÔ∏è Alt: ${pin.altitude}m
                        </div>
                        <div class="distance">${distanceText}</div>
                        <div class="pin-actions">
                            <button class="btn-small btn-danger" onclick="removePin(${pin.id})">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Save pins to localStorage
        function savePins() {
            localStorage.setItem('geopin-pins', JSON.stringify(pins));
        }

        // Load pins from localStorage
        function loadPins() {
            const saved = localStorage.getItem('geopin-pins');
            if (saved) {
                pins = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>