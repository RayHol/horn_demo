<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animals Everywhere! - Animals</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/menu.css">
    
    <!-- Custom Fonts -->
    <style>
        @font-face {
            font-family: 'BentonSans';
            src: url('../assets/fonts/BentonSansCompBlackRegular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'BentonSans Book';
            src: url('../assets/fonts/BentonSans Book.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Amatic SC';
            src: url('../assets/fonts/Amatic SC Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Amatic SC';
            src: url('../assets/fonts/Amatic-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
    </style>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Dynamic viewport height support */
        @supports (height: 100dvh) {
            body {
                height: 100dvh;
            }
        }

        /* Fix for mobile Safari */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }

        body {
            background: linear-gradient(to bottom, #FFFFFF 0%, #C6C8C6 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color);
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0px 4px 0px 0px var(--button-shadow);
        }

        .back-button:hover {
            transform: translateY(2px);
            box-shadow: 0px 2px 0px 0px var(--button-shadow);
        }

        .back-button:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .back-button img {
            width: 24px;
            height: 24px;
        }

        .title {
            font-family: "Amatic SC", sans-serif;
            font-size: 27px;
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            margin-top: 20px;
            width: 100%;
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none; /* Allow clicks to pass through to button */
            z-index: 1;
        }

        .title-unlock-button {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 50px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 2;
            /* Make it invisible but clickable */
            opacity: 0;
        }

        .hidden {
            display: none !important;
        }

        .orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .orientation-content {
            text-align: center;
            color: white;
            padding: 2rem;
        }

        .orientation-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .badge-detail-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FCF6EF;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }

        .badge-detail-popup.show {
            transform: translateX(0);
        }

        .starburst-background-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150vw;
            height: 150vh;
            min-width: 1200px;
            min-height: 1200px;
            pointer-events: none;
            z-index: 0;
            transform: translate(-50%, -50%);
            transform-origin: 50% 41.13%;
            animation: rotateStarburst 60s linear infinite;
            opacity: 1;
        }

        .starburst-background-overlay img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        @keyframes rotateStarburst {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .badge-detail-popup .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #D64D1B;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 100; /* Higher z-index to ensure it's clickable above other elements */
            pointer-events: auto; /* Ensure button can receive clicks */
        }

        .badge-detail-popup .back-button:hover {
            background-color: #B83D15;
        }

        .badge-detail-popup .back-button img {
            width: 24px;
            height: 24px;
            filter: invert(1);
        }

        .badge-detail-popup .title {
            font-family: "Amatic SC", sans-serif;
            font-size: 27px;
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            margin-top: 20px;
            width: 100%;
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }

        .badge-detail-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-top: 125px;
            padding-left: 20px;
            padding-right: 20px;
            position: relative;
            z-index: 10;
        }

        .badge-detail-icon {
            width: 275px;
            height: 275px;
            object-fit: contain;
            margin-bottom: 2rem;
        }

        .badge-detail-name {
            color: var(--Texts-textMain, #3A2E27);
            text-align: center;
            -webkit-text-stroke-width: 0.5px;
            -webkit-text-stroke-color: var(--Texts-textMain, #3A2E27);
            font-family: "Amatic SC", sans-serif;
            font-size: 48px;
            font-style: normal;
            font-weight: 700;
            line-height: 100%; /* 48px */
            margin: 0 0 1rem 0;
        }

        .badge-detail-date {
            font-family: "BentonSans Book", sans-serif;
            font-size: 16px;
            color: #3A2E27;
            margin: 0 0 1.5rem 0;
            text-align: center;
            line-height: 140%;
        }

        .badge-detail-description {
            color: var(--Texts-textMain, #3A2E27);
            text-align: center;
            font-family: "BentonSans Book", sans-serif;
            font-size: 16px;
            font-style: normal;
            font-weight: 400;
            line-height: 140%;
            margin: 0 0 2rem 0;
        }

        .badge-detail-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            width: 100%;
            max-width: 300px;
            margin-top: 1rem;
        }

        .badge-detail-popup .primaryButton {
            display: flex;
            width: 220px;
            min-width: 104px;
            padding: 12px 16px;
            justify-content: center;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            background: var(--UI-primary, #C14400);
            box-shadow: 0 4px 0 0 #962F00;
            color: var(--Texts-textWhite, #FCEFE1);
            text-align: center;
            font-family: "BentonSans" !important;
            font-size: 24px;
            font-style: normal;
            font-weight: 400;
            line-height: 120%;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .badge-detail-popup .primaryButton:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #962F00;
        }

        .badge-detail-popup .primaryButton:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .badge-detail-popup .secondaryButton {
            display: flex;
            width: 220px;
            min-width: 104px;
            padding: 12px 16px;
            justify-content: center;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            background: var(--Background-main, #FCEFE1);
            border: 2px solid var(--UI-primary, #E7D4A3);
            box-shadow: 0 3px 0 0 var(--UI-primary, #E7D4A3);
            color: var(--Texts-textMain, #3A2E27);
            text-align: center;
            font-family: "BentonSans" !important;
            font-size: 24px;
            font-style: normal;
            font-weight: 400;
            line-height: 120%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .badge-detail-popup .secondaryButton:hover {
            transform: translateY(2px);
            box-shadow: 0 1px 0 0 var(--UI-primary, #E7D4A3);
        }

        .badge-detail-popup .secondaryButton:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        /* 3D Button Styling */
        .animal-3d-button {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            width: 53px;
            height: 48px;
            padding: 10px 13.333px;
            justify-content: center;
            align-items: center;
            gap: 6.667px;
            border-radius: 10px;
            border: 1px solid #E7D4A3;
            background: #FCEFE1;
            box-shadow: 0 3px 0 0 #E7D4A3;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 100;
            pointer-events: auto;
        }

        .animal-3d-button:hover {
            transform: translateY(1px);
            box-shadow: 0 2px 0 0 #E7D4A3;
        }

        .animal-3d-button:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        .animal-3d-button img {
            width: 26.667px;
            height: 26.667px;
            flex-shrink: 0;
        }

        /* 3D Model Viewer Overlay */
        .model-viewer-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FCF6EF;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }

        .model-viewer-popup.show {
            transform: translateX(0);
        }

        .model-viewer-header {
            position: relative;
            background-color: #FCF6EF;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            z-index: 10;
        }

        .model-viewer-back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #D64D1B;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 0 #962F00;
        }

        .model-viewer-back-button:hover {
            transform: translateY(-50%) translateY(2px);
            box-shadow: 0 2px 0 0 #962F00;
        }

        .model-viewer-back-button:active {
            transform: translateY(-50%) translateY(4px);
            box-shadow: none;
        }

        .model-viewer-back-button img {
            width: 24px;
            height: 24px;
            filter: invert(1);
        }

        .model-viewer-title {
            font-family: "Amatic SC", sans-serif;
            font-size: 27px;
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            margin: 0;
        }

        .model-viewer-ar-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #D64D1B;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: "BentonSans", sans-serif;
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 0 #962F00;
        }

        .model-viewer-ar-button:hover {
            transform: translateY(-50%) translateY(2px);
            box-shadow: 0 2px 0 0 #962F00;
        }

        .model-viewer-ar-button:active {
            transform: translateY(-50%) translateY(4px);
            box-shadow: none;
        }

        .model-viewer-container {
            flex: 1;
            width: 100%;
            height: calc(100% - 60px);
            position: relative;
            overflow: hidden;
        }

        /* Hide default AR button from model-viewer */
        .model-viewer-container model-viewer::part(ar-button),
        .model-viewer-container model-viewer [slot="ar-button"],
        .model-viewer-container #default-ar-button,
        #modelViewerContainer model-viewer::part(ar-button),
        #modelViewerContainer model-viewer [slot="ar-button"],
        #modelViewerContainer #default-ar-button {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Responsive adjustments for badge detail popup */
        @media (max-width: 480px) {
            .badge-detail-content {
                width: 95%;
                padding: 1.5rem;
            }
            
            .badge-detail-title {
                font-size: 36px;
            }
            
            .badge-detail-icon {
                width: 206px;
                height: 206px;
            }
            
            .badge-detail-name {
                font-size: 36px;
            }
            
            .badge-detail-description {
                font-size: 16px;
            }
        }

        /* Animal Grid Styling */
        .animal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            gap: 15px 3px;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            margin-top: 140px;
            padding-bottom: 40px;
        }

        .animal-item {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            position: relative;
        }

        .animal-image {
            width: 90%;
            height: 90%;
            object-fit: contain;
            max-width: 180px;
            max-height: 180px;
            transition: transform 0.2s ease;
            box-sizing: border-box;
        }

        /* Uncollected animals - grey silhouettes, faded */
        .animal-item:not([data-collected="true"]) .animal-image:not(.collected-animal) {
            filter: grayscale(100%) brightness(0.4) opacity(0.5);
            transition: filter 0.3s ease, transform 0.2s ease;
        }

        /* Collected animals are 25% bigger than placeholder animals */
        .collected-animal {
            opacity: 0;
            transform: scale(0.3);
            transform-origin: center center;
            width: 90% !important;
            height: 90% !important;
            max-width: 180px !important;
            max-height: 180px !important;
            object-fit: contain !important;
            will-change: transform, opacity;
            backface-visibility: hidden;
            filter: none; /* Full color for collected animals */
        }

        /* Scale collected animals to be 10% smaller than previous size */
        .collected-animal.animation-complete {
            transform: scale(1.265625) !important;
            transform-origin: center center;
            width: 90% !important;
            height: 90% !important;
            max-width: 180px !important;
            max-height: 180px !important;
            object-fit: contain !important;
            opacity: 1 !important; /* Full opacity for collected animals */
            filter: none !important; /* Full color for collected animals */
        }

        .animal-item:hover .animal-image:not(.collected-animal) {
            transform: scale(1.20);
            filter: grayscale(100%) brightness(0.5) opacity(0.6);
        }

        .animal-item:hover .collected-animal {
            transform: scale(1.20);
        }

        @keyframes animalCollect {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            60% {
                opacity: 1;
                transform: scale(1.62);
            }
            100% {
                opacity: 1;
                transform: scale(1.265625);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .animal-grid {
                gap: 12px 4px;
                padding: 15px;
                margin-top: 100px;
                padding-bottom: 40px;
            }
            
            .animal-image {
                max-width: 140px;
                max-height: 140px;
            }
            
            .collected-animal {
                width: 90% !important;
                height: 90% !important;
                max-width: 140px !important;
                max-height: 140px !important;
                object-fit: contain !important;
            }
            
            .collected-animal.animation-complete {
                transform: scale(1.265625) !important;
                width: 90% !important;
                height: 90% !important;
                max-width: 140px !important;
                max-height: 140px !important;
                object-fit: contain !important;
            }
        }

        @media (max-width: 360px) {
            .animal-grid {
                gap: 10px 3px;
                padding: 10px;
                margin-top: 80px;
                padding-bottom: 40px;
            }
            
            .animal-image {
                max-width: 120px;
                max-height: 120px;
            }
            
            .collected-animal {
                width: 90% !important;
                height: 90% !important;
                max-width: 120px !important;
                max-height: 120px !important;
                object-fit: contain !important;
            }
            
            .collected-animal.animation-complete {
                transform: scale(1.265625) !important;
                width: 90% !important;
                height: 90% !important;
                max-width: 120px !important;
                max-height: 120px !important;
                object-fit: contain !important;
            }
        }
    </style>
    
    <!-- Customer.io Helper (loads before Customer.io snippet) -->
    <script src="../scripts/customer-io-helper.js"></script>
    <!-- Customer.io snippet will go here when available -->
</head>
<body>
    <!-- Orientation Warning Overlay -->
    <div id="orientationOverlay" class="orientation-overlay hidden">
        <div class="orientation-content">
            <div class="orientation-icon">ðŸ“±</div>
            <h2>Please Rotate Your Device</h2>
            <p>Hold your device in portrait mode for the best experience</p>
        </div>
    </div>

    <button class="back-button" onclick="window.location.href='menu.html'" aria-label="Back to menu">
        <img src="../assets/Arrow2.png" alt="Back">
    </button>
    <h1 class="title">Animals</h1>
    <button class="title-unlock-button" id="titleUnlockButton" aria-label="Unlock all animals"></button>

    <!-- Animal Grid Container -->
    <div class="animal-grid">
        <!-- Row 1 - Animal AR Animals -->
        <div class="animal-item" data-animal="peacock">
            <img src="" alt="Peacock" class="animal-image">
            <img src="" alt="Peacock" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="walrus-ar">
            <img src="" alt="Walrus" class="animal-image">
            <img src="" alt="Walrus" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="koala">
            <img src="" alt="Koala" class="animal-image">
            <img src="" alt="Koala" class="animal-image collected-animal" style="display: none;">
        </div>

        <!-- Row 2 - Animal AR Animals -->
        <div class="animal-item" data-animal="bee-ar">
            <img src="" alt="Bee" class="animal-image">
            <img src="" alt="Bee" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="clownfish-ar">
            <img src="" alt="Clownfish" class="animal-image">
            <img src="" alt="Clownfish" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="platypus">
            <img src="" alt="Platypus" class="animal-image">
            <img src="" alt="Platypus" class="animal-image collected-animal" style="display: none;">
        </div>

        <!-- Row 3 - Animal AR Animals -->
        <div class="animal-item" data-animal="cephalopod">
            <img src="" alt="Cephalopod" class="animal-image">
            <img src="" alt="Cephalopod" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="stag-beetle">
            <img src="" alt="Stag Beetle" class="animal-image">
            <img src="" alt="Stag Beetle" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="snowy-owl">
            <img src="" alt="Snowy Owl" class="animal-image">
            <img src="" alt="Snowy Owl" class="animal-image collected-animal" style="display: none;">
        </div>

        <!-- Row 4 - Animal AR Animals -->
        <div class="animal-item" data-animal="orangutan">
            <img src="" alt="Orangutan" class="animal-image">
            <img src="" alt="Orangutan" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="jellyfish-ar">
            <img src="" alt="Jellyfish" class="animal-image">
            <img src="" alt="Jellyfish" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="robin">
            <img src="" alt="Robin" class="animal-image">
            <img src="" alt="Robin" class="animal-image collected-animal" style="display: none;">
        </div>

        <!-- Row 5 - Additional Animals -->
        <div class="animal-item" data-animal="butterfly">
            <img src="" alt="Butterfly" class="animal-image">
            <img src="" alt="Butterfly" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="crocodile">
            <img src="" alt="Crocodile" class="animal-image">
            <img src="" alt="Crocodile" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="dodo">
            <img src="" alt="Dodo" class="animal-image">
            <img src="" alt="Dodo" class="animal-image collected-animal" style="display: none;">
        </div>

        <!-- Row 6 - Additional Animals -->
        <div class="animal-item" data-animal="fox">
            <img src="" alt="Fox" class="animal-image">
            <img src="" alt="Fox" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="grass-snake">
            <img src="" alt="Grass Snake" class="animal-image">
            <img src="" alt="Grass Snake" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="ostrich">
            <img src="" alt="Ostrich" class="animal-image">
            <img src="" alt="Ostrich" class="animal-image collected-animal" style="display: none;">
        </div>

        <!-- Row 7 - Additional Animals -->
        <div class="animal-item" data-animal="puffin">
            <img src="" alt="Puffin" class="animal-image">
            <img src="" alt="Puffin" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="tiger-cub">
            <img src="" alt="Tiger Cub" class="animal-image">
            <img src="" alt="Tiger Cub" class="animal-image collected-animal" style="display: none;">
        </div>
        <div class="animal-item" data-animal="velociraptor">
            <img src="" alt="Velociraptor" class="animal-image">
            <img src="" alt="Velociraptor" class="animal-image collected-animal" style="display: none;">
        </div>
    </div>

    <!-- Animal Detail Popup -->
    <div id="animalDetailPopup" class="badge-detail-popup hidden">
        <div class="starburst-background-overlay"></div>
        <button class="back-button" onclick="closeAnimalDetail()">
            <img src="../assets/close_button.png" alt="Close">
        </button>
        <h1 class="title">ANIMAL DETAILS</h1>
        <button id="animal3DButton" class="animal-3d-button" onclick="open3DViewer()" style="display: none;">
            <img src="../assets/3D.svg" alt="View 3D Model">
        </button>
        
        <div class="badge-detail-main">
            <img id="animalDetailIcon" src="" alt="Animal" class="badge-detail-icon">
            <h2 id="animalDetailName" class="badge-detail-name"></h2>
            <p id="animalDetailDate" class="badge-detail-date"></p>
            <p id="animalDetailDescription" class="badge-detail-description"></p>
            <div class="badge-detail-buttons">
                <button id="animalPlayGameButton" class="secondaryButton" onclick="playGame()" style="display: none;">Play Game</button>
            </div>
        </div>
    </div>

    <!-- 3D Model Viewer Overlay -->
    <div id="modelViewerOverlay" class="model-viewer-popup hidden">
        <div class="model-viewer-header">
            <button class="model-viewer-back-button" onclick="close3DViewer()">
                <img src="../assets/Arrow.png" alt="Back">
            </button>
            <h1 class="model-viewer-title">3D MODEL</h1>
            <button class="model-viewer-ar-button" id="modelViewerARButton" onclick="launchAR()" style="display: none;">
                <span>AR</span>
            </button>
        </div>
        <div id="modelViewerContainer" class="model-viewer-container"></div>
    </div>

    <!-- Model Viewer Library -->
    <script type="module" src="https://modelviewer.dev/node_modules/@google/model-viewer/dist/model-viewer.min.js"></script>
    <link rel="stylesheet" href="../styles/model-viewer.css">
    <script src="../scripts/model-viewer.js"></script>
    
    <script src="../scripts/audio-manager-main.js"></script>
    <script>
        // Orientation Detection
        class OrientationManager {
            constructor() {
                this.orientationOverlay = document.getElementById('orientationOverlay');
                
                // Ensure overlay starts hidden
                if (this.orientationOverlay) {
                    this.orientationOverlay.classList.add('hidden');
                }
                
                this.init();
            }
            
            init() {
                // Check initial orientation
                this.checkOrientation();
                
                // Listen for orientation changes
                window.addEventListener('orientationchange', () => {
                    // Small delay to ensure the orientation change is complete
                    setTimeout(() => this.checkOrientation(), 100);
                });
                
                // Also listen for resize events as a backup
                window.addEventListener('resize', () => {
                    setTimeout(() => this.checkOrientation(), 100);
                });
            }
            
            checkOrientation() {
                // Use screen orientation API if available, fallback to window dimensions
                let isLandscape = false;
                
                if (screen.orientation) {
                    // Use screen orientation API for more accurate detection
                    isLandscape = screen.orientation.angle === 90 || screen.orientation.angle === 270;
                } else {
                    // Fallback to window dimensions with a small tolerance
                    isLandscape = window.innerWidth > window.innerHeight + 50;
                }
                
                if (isLandscape) {
                    this.orientationOverlay.classList.remove('hidden');
                } else {
                    this.orientationOverlay.classList.add('hidden');
                }
            }
        }

        // Title tap counter for unlock-all mode
        let titleTapCount = 0;
        let titleTapResetTimer = null;
        const TITLE_TAP_RESET_TIME = 2000; // Reset counter after 2 seconds of no taps

        function setupTitleUnlockButton() {
            const titleButton = document.getElementById('titleUnlockButton');
            if (!titleButton) return;
            
            titleButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Reset timer if it exists
                if (titleTapResetTimer) {
                    clearTimeout(titleTapResetTimer);
                }
                
                titleTapCount++;
                console.log('Title tapped:', titleTapCount, 'times');
                
                // If 4 taps, toggle unlock-all mode
                if (titleTapCount >= 4) {
                    toggleUnlockAllAnimals();
                    titleTapCount = 0;
                    // Trigger haptic feedback
                    if (typeof triggerHaptic === 'function') {
                        triggerHaptic('medium');
                    }
                } else {
                    // Set timer to reset counter if no more taps
                    titleTapResetTimer = setTimeout(() => {
                        titleTapCount = 0;
                        console.log('Title tap counter reset');
                    }, TITLE_TAP_RESET_TIME);
                }
            });
        }

        // Initialize orientation manager when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            new OrientationManager();
            setupTitleUnlockButton();
            await initializeAnimalCollection();
            addAnimalClickListeners();
            
            // Initialize starburst background in animal detail popup
            function initStarburstOverlay() {
                const popup = document.getElementById('animalDetailPopup');
                if (popup) {
                    const overlay = popup.querySelector('.starburst-background-overlay');
                    if (overlay && !overlay.querySelector('img')) {
                        const img = document.createElement('img');
                        img.src = '../assets/Startburst.svg';
                        img.alt = 'Starburst background';
                        overlay.appendChild(img);
                    }
                }
            }
            
            // Initialize when popup is shown
            const observer = new MutationObserver(() => {
                initStarburstOverlay();
            });
            
            observer.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
            
            // Initial check
            initStarburstOverlay();
        });

        // Map badge ID to animal name (for looking up in JSON)
        function getAnimalNameFromBadgeId(badgeId) {
            const badgeToNameMap = {
                'peacock': 'Peacock',
                'walrus-ar': 'Walrus',
                'koala': 'Koala',
                'bee-ar': 'Bee',
                'clownfish-ar': 'Clown Fish',
                'platypus': 'Platypus',
                'cephalopod': 'Cephalopod',
                'stag-beetle': 'Stag Beetle',
                'snowy-owl': 'Snowy Owl',
                'orangutan': 'Orangutan',
                'jellyfish-ar': 'Jellyfish',
                'robin': 'Robin',
                'butterfly': 'Butterfly',
                'crocodile': 'Crocodile',
                'dodo': 'Dodo',
                'fox': 'Fox',
                'grass-snake': 'Grass Snake',
                'ostrich': 'Ostrich',
                'puffin': 'Puffin',
                'tiger-cub': 'Tiger Cub',
                'velociraptor': 'Velociraptor'
            };
            return badgeToNameMap[badgeId] || null;
        }

        // Map animal name to badge ID (reverse lookup)
        function getBadgeIdFromAnimalName(animalName) {
            const nameToBadgeMap = {
                'Peacock': 'peacock',
                'Walrus': 'walrus-ar',
                'Koala': 'koala',
                'Bee': 'bee-ar',
                'Clown Fish': 'clownfish-ar',
                'Platypus': 'platypus',
                'Cephalopod': 'cephalopod',
                'Stag Beetle': 'stag-beetle',
                'Snowy Owl': 'snowy-owl',
                'Orangutan': 'orangutan',
                'Jellyfish': 'jellyfish-ar',
                'Robin': 'robin'
            };
            return nameToBadgeMap[animalName] || null;
        }

        // Load animals from JSON and update icon sources
        async function loadAnimalIconsFromJSON() {
            try {
                // Get environment from localStorage (set by wayfinding page)
                let environment = 'production';
                try {
                    const saved = localStorage.getItem('wayfinding-environment');
                    if (saved === 'testing' || saved === 'production') {
                        environment = saved;
                    }
                } catch (_) {
                    // localStorage not available, use default
                }
                
                const jsonFile = environment === 'testing' ? '../data/testing.json' : '../data/animals.json';
                const res = await fetch(jsonFile, { cache: 'no-cache' });
                const cfg = await res.json();
                const animals = Array.isArray(cfg.animals) ? cfg.animals : [];
                
                // Create a map of animal name to icon paths
                const animalIconMap = {};
                animals.forEach(animal => {
                    if (animal.name && animal.icon && animal.icon.shadow && animal.icon.found) {
                        // Convert paths from ../assets/ to ../assets/ (since animals.html is in pages/)
                        animalIconMap[animal.name] = {
                            shadow: animal.icon.shadow.replace('../assets/', '../assets/'),
                            found: animal.icon.found.replace('../assets/', '../assets/')
                        };
                    }
                });
                
                // Update all animal items with icons from JSON
                document.querySelectorAll('.animal-item[data-animal]').forEach(animalItem => {
                    const badgeId = animalItem.getAttribute('data-animal');
                    const animalName = getAnimalNameFromBadgeId(badgeId);
                    
                    if (animalName && animalIconMap[animalName]) {
                        const placeholder = animalItem.querySelector('.animal-image:not(.collected-animal)');
                        const collectedAnimal = animalItem.querySelector('.collected-animal');
                        
                        // Update placeholder (shadow) icon
                        if (placeholder) {
                            placeholder.src = animalIconMap[animalName].shadow;
                            placeholder.alt = animalName;
                        }
                        
                        // Update collected (found) icon
                        if (collectedAnimal) {
                            collectedAnimal.src = animalIconMap[animalName].found;
                            collectedAnimal.alt = animalName;
                        }
                    }
                });
                
                return animalIconMap;
            } catch (err) {
                console.error('Failed to load animal icons from JSON:', err);
                return {};
            }
        }

        // Animal Collection System
        // Testing mode: unlock all animals temporarily
        let originalCollectedAnimals = null;
        let isUnlockAllAnimalsMode = false;

        function toggleUnlockAllAnimals() {
            if (!isUnlockAllAnimalsMode) {
                // Store original data
                originalCollectedAnimals = JSON.parse(localStorage.getItem('collectedBadges') || '[]');
                
                // Animal badge IDs that correspond to animals
                const animalBadgeIds = ['peacock', 'walrus-ar', 'koala', 'bee-ar', 'clownfish-ar', 'platypus', 'cephalopod', 'stag-beetle', 'snowy-owl', 'orangutan', 'jellyfish-ar', 'robin', 'butterfly', 'crocodile', 'dodo', 'fox', 'grass-snake', 'ostrich', 'puffin', 'tiger-cub', 'velociraptor'];
                
                // Temporarily set all animals as collected (don't save to localStorage)
                sessionStorage.setItem('tempUnlockAllAnimals', 'true');
                sessionStorage.setItem('originalCollectedAnimals', JSON.stringify(originalCollectedAnimals));
                sessionStorage.setItem('tempAllAnimals', JSON.stringify(animalBadgeIds));
                
                isUnlockAllAnimalsMode = true;
                console.log('Unlocked all animals for testing');
                console.log('sessionStorage tempUnlockAllAnimals:', sessionStorage.getItem('tempUnlockAllAnimals'));
                console.log('sessionStorage tempAllAnimals:', sessionStorage.getItem('tempAllAnimals'));
                
                // Re-initialize to show all animals
                initializeAnimalCollection();
                
                // If detail popup is open, refresh it to show unlocked state
                const popup = document.getElementById('animalDetailPopup');
                if (popup && !popup.classList.contains('hidden') && currentAnimalId) {
                    showAnimalDetail(currentAnimalId);
                }
            } else {
                // Restore original data
                const original = JSON.parse(sessionStorage.getItem('originalCollectedAnimals') || '[]');
                sessionStorage.removeItem('tempUnlockAllAnimals');
                sessionStorage.removeItem('originalCollectedAnimals');
                sessionStorage.removeItem('tempAllAnimals');
                
                isUnlockAllAnimalsMode = false;
                console.log('Restored original animal collection');
                
                // Re-initialize to show only original animals
                initializeAnimalCollection();
                
                // If detail popup is open, refresh it to show original state
                const popup = document.getElementById('animalDetailPopup');
                if (popup && !popup.classList.contains('hidden') && currentAnimalId) {
                    showAnimalDetail(currentAnimalId);
                }
            }
        }

        async function initializeAnimalCollection() {
            // Load icons from JSON first
            await loadAnimalIconsFromJSON();
            
            // Check if we're in unlock-all mode
            const tempUnlock = sessionStorage.getItem('tempUnlockAllAnimals') === 'true';
            let collectedBadges;
            
            if (tempUnlock) {
                // Use all animals for testing
                collectedBadges = JSON.parse(sessionStorage.getItem('tempAllAnimals') || '[]');
                isUnlockAllAnimalsMode = true;
            } else {
                // Use actual collected badges from localStorage
                collectedBadges = JSON.parse(localStorage.getItem('collectedBadges') || '[]');
                isUnlockAllAnimalsMode = false;
            }
            
            // Animal badge IDs that correspond to animals (including future animals)
            const animalBadgeIds = ['peacock', 'walrus-ar', 'koala', 'bee-ar', 'clownfish-ar', 'platypus', 'cephalopod', 'stag-beetle', 'snowy-owl', 'orangutan', 'jellyfish-ar', 'robin', 'butterfly', 'crocodile', 'dodo', 'fox', 'grass-snake', 'ostrich', 'puffin', 'tiger-cub', 'velociraptor'];
            
            // Show collected animals and hide placeholder animals
            collectedBadges.forEach(badgeId => {
                if (animalBadgeIds.includes(badgeId)) {
                    const animalItem = document.querySelector(`[data-animal="${badgeId}"]`);
                    if (animalItem) {
                        const placeholder = animalItem.querySelector('.animal-image:not(.collected-animal)');
                        const collectedAnimal = animalItem.querySelector('.collected-animal');
                        
                        if (placeholder) {
                            placeholder.style.display = 'none';
                        }
                        if (collectedAnimal) {
                            collectedAnimal.style.display = 'block';
                            // Mark as ready for animation
                            collectedAnimal.setAttribute('data-ready', 'true');
                            // Mark the item as collected for CSS targeting
                            animalItem.setAttribute('data-collected', 'true');
                        }
                    }
                }
            });
            
            console.log('Collected animals from localStorage:', collectedBadges.filter(id => animalBadgeIds.includes(id)));
            
            // Trigger truly sequential animations - each animal waits for previous to finish
            setTimeout(() => {
                const collectedAnimalElements = document.querySelectorAll('.collected-animal[data-ready="true"]');
                const visibleAnimals = Array.from(collectedAnimalElements).filter(animal => 
                    animal.style.display !== 'none' && animal.offsetParent !== null
                );
                
                console.log('Found animals to animate:', visibleAnimals.length);
                
                // Function to animate a single animal and then trigger the next
                function animateAnimalSequentially(animalIndex) {
                    if (animalIndex >= visibleAnimals.length) {
                        console.log('All animals animated');
                        return; // All animals animated
                    }
                    
                    const animal = visibleAnimals[animalIndex];
                    console.log('Animating animal', animalIndex, animal);
                    
                    // Reset animal state
                    animal.style.animation = 'none';
                    animal.style.opacity = '0';
                    animal.style.transform = 'scale(0.3)';
                    
                    // Force reflow
                    animal.offsetHeight;
                    
                    // Start animation
                    animal.style.animation = 'animalCollect 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
                    
                    // Wait for this animal to finish, then animate the next one
                    const handleAnimationEnd = () => {
                        console.log('Animal animation ended:', animalIndex);
                        animal.classList.add('animation-complete');
                        animal.removeEventListener('animationend', handleAnimationEnd);
                        
                        // Start the next animal after a small pause
                        setTimeout(() => {
                            animateAnimalSequentially(animalIndex + 1);
                        }, 60); // Reduced pause for faster flow
                    };
                    
                    animal.addEventListener('animationend', handleAnimationEnd);
                }
                
                // Start the sequential animation
                if (visibleAnimals.length > 0) {
                    animateAnimalSequentially(0);
                }
            }, 150);
        }

        // Animal detail popup functionality
        async function showAnimalDetail(animalId) {
            const popup = document.getElementById('animalDetailPopup');
            const icon = document.getElementById('animalDetailIcon');
            const name = document.getElementById('animalDetailName');
            const date = document.getElementById('animalDetailDate');
            const description = document.getElementById('animalDetailDescription');
            const threeDButton = document.getElementById('animal3DButton');
            
            // Set current animal ID for 3D viewer
            currentAnimalId = animalId;
            
            // Check if animal is found - check unlock-all mode first
            // Check both the global variable and sessionStorage for redundancy
            let isFound = false;
            
            // First check the global variable (set by toggleUnlockAllAnimals)
            if (typeof isUnlockAllAnimalsMode !== 'undefined' && isUnlockAllAnimalsMode === true) {
                isFound = true;
                console.log('âœ“ Unlock-all mode active (global variable) - treating animal as found');
            } else {
                // Fallback to sessionStorage check
                try {
                    const tempUnlockValue = sessionStorage.getItem('tempUnlockAllAnimals');
                    const tempUnlock = tempUnlockValue === 'true';
                    
                    console.log('showAnimalDetail - animalId:', animalId);
                    console.log('isUnlockAllAnimalsMode:', typeof isUnlockAllAnimalsMode !== 'undefined' ? isUnlockAllAnimalsMode : 'undefined');
                    console.log('tempUnlockValue:', tempUnlockValue, 'tempUnlock:', tempUnlock);
                    
                    if (tempUnlock) {
                        // In unlock-all mode, ALL animals are treated as found
                        isFound = true;
                        console.log('âœ“ Unlock-all mode active (sessionStorage) - treating animal as found');
                    } else {
                        // Normal mode - get from localStorage
                        try {
                            const collectedBadges = JSON.parse(localStorage.getItem('collectedBadges') || '[]');
                            isFound = Array.isArray(collectedBadges) && collectedBadges.includes(animalId);
                            console.log('Normal mode - collectedBadges:', collectedBadges, 'isFound:', isFound);
                        } catch (e) {
                            console.warn('Error parsing collectedBadges:', e);
                            isFound = false;
                        }
                    }
                } catch (e) {
                    console.error('Error accessing sessionStorage:', e);
                    // Fallback to localStorage check
                    try {
                        const collectedBadges = JSON.parse(localStorage.getItem('collectedBadges') || '[]');
                        isFound = Array.isArray(collectedBadges) && collectedBadges.includes(animalId);
                    } catch (e2) {
                        console.warn('Error parsing collectedBadges:', e2);
                        isFound = false;
                    }
                }
            }
            
            console.log('Final isFound value:', isFound, 'for animal:', animalId);
            
            // Load animal icons and descriptions from JSON
            let animalIconMap = {};
            let animalDescriptionMap = {};
            let animals = [];
            try {
                // Get environment from localStorage (set by wayfinding page)
                let environment = 'production';
                try {
                    const saved = localStorage.getItem('wayfinding-environment');
                    if (saved === 'testing' || saved === 'production') {
                        environment = saved;
                    }
                } catch (_) {
                    // localStorage not available, use default
                }
                
                const jsonFile = environment === 'testing' ? '../data/testing.json' : '../data/animals.json';
                const res = await fetch(jsonFile, { cache: 'no-cache' });
                const cfg = await res.json();
                animals = Array.isArray(cfg.animals) ? cfg.animals : [];
                animals.forEach(animal => {
                    if (animal.name) {
                        const badgeId = getBadgeIdFromAnimalName(animal.name);
                        if (badgeId) {
                            // Store icon paths if available
                            if (animal.icon && animal.icon.shadow && animal.icon.found) {
                                animalIconMap[badgeId] = {
                                    shadow: animal.icon.shadow.replace('../assets/', '../assets/'),
                                    found: animal.icon.found.replace('../assets/', '../assets/')
                                };
                            }
                            // Store description if available
                            if (animal.description) {
                                animalDescriptionMap[badgeId] = animal.description;
                            }
                        }
                    }
                });
            } catch (e) {
                console.warn('Error loading animal data from JSON:', e);
            }
            
            // Animal data - matching badge data for consistency
            const animalData = {
                'peacock': {
                    icon: '../assets/animals/found/peacock.svg',
                    name: 'Peacock',
                    description: 'You found the magnificent peacock! A true explorer of the Horniman grounds.',
                    gamePath: '../games/proud-photographer/index.html'
                },
                'walrus-ar': {
                    icon: '../assets/animals/found/walrus.svg',
                    name: 'Walrus',
                    description: 'You discovered the walrus! Great tracking skills on your adventure.',
                    gamePath: '../games/walrus-feeder/index.html'
                },
                'koala': {
                    icon: '../assets/animals/found/koala.svg',
                    name: 'Koala',
                    description: 'You found the koala! Your keen eye spotted this hidden treasure.'
                },
                'bee-ar': {
                    icon: '../assets/animals/found/bee.svg',
                    name: 'Bee',
                    description: 'You found the bee! A tiny but important discovery on your journey.',
                    gamePath: '../games/sunflower-planter/index.html'
                },
                'clownfish-ar': {
                    icon: '../assets/animals/found/clownfish.svg',
                    name: 'Clownfish',
                    description: 'You found the clownfish! A colorful addition to your collection.',
                    gamePath: '../games/anemone-cleaning/index.html'
                },
                'platypus': {
                    icon: '../assets/animals/found/platypus.svg',
                    name: 'Platypus',
                    description: 'You found the platypus! One of nature\'s most unique creatures.'
                },
                'cephalopod': {
                    icon: '../assets/animals/found/Shelled cephalopod.svg',
                    name: 'Cephalopod',
                    description: 'You found the cephalopod! A fascinating marine discovery.'
                },
                'stag-beetle': {
                    icon: '../assets/animals/found/stag beetle.svg',
                    name: 'Stag Beetle',
                    description: 'You found the stag beetle! A small but impressive find.'
                },
                'snowy-owl': {
                    icon: '../assets/animals/found/snowy owl.svg',
                    name: 'Snowy Owl',
                    description: 'You found the snowy owl! A wise and majestic discovery.'
                },
                'orangutan': {
                    icon: '../assets/animals/found/orangutan.svg',
                    name: 'Orangutan',
                    description: 'You found the orangutan! A great ape discovery on your adventure.'
                },
                'jellyfish-ar': {
                    icon: '../assets/animals/found/jellyfish.svg',
                    name: 'Jellyfish',
                    description: 'You found the jellyfish! A graceful and mesmerizing discovery.'
                },
                'robin': {
                    icon: '../assets/animals/found/robin.svg',
                    name: 'Robin',
                    description: 'You found the robin! A cheerful bird to add to your collection.'
                },
                'butterfly': {
                    icon: '../assets/animals/found/butterfly.svg',
                    name: 'Butterfly',
                    description: 'You found the butterfly! A beautiful and delicate discovery.'
                },
                'crocodile': {
                    icon: '../assets/animals/found/crocodile.svg',
                    name: 'Crocodile',
                    description: 'You found the crocodile! A powerful and ancient creature.'
                },
                'dodo': {
                    icon: '../assets/animals/found/dodo.svg',
                    name: 'Dodo',
                    description: 'You found the dodo! A rare and fascinating discovery from history.'
                },
                'fox': {
                    icon: '../assets/animals/found/fox.svg',
                    name: 'Fox',
                    description: 'You found the fox! A clever and cunning discovery.'
                },
                'grass-snake': {
                    icon: '../assets/animals/found/grass snake.svg',
                    name: 'Grass Snake',
                    description: 'You found the grass snake! A slithery and fascinating discovery.'
                },
                'ostrich': {
                    icon: '../assets/animals/found/ostrich.svg',
                    name: 'Ostrich',
                    description: 'You found the ostrich! The world\'s largest bird discovery.'
                },
                'puffin': {
                    icon: '../assets/animals/found/puffin.svg',
                    name: 'Puffin',
                    description: 'You found the puffin! A colorful seabird discovery.'
                },
                'tiger-cub': {
                    icon: '../assets/animals/found/tiger cub.svg',
                    name: 'Tiger Cub',
                    description: 'You found the tiger cub! A fierce and adorable discovery.'
                },
                'velociraptor': {
                    icon: '../assets/animals/found/velocirapton.svg',
                    name: 'Velociraptor',
                    description: 'You found the velociraptor! A prehistoric predator discovery.'
                }
            };
            
            if (animalData[animalId]) {
                // Update icon - use shadow icon if not found, found icon if found
                if (isFound) {
                    // Use found icon
                    if (animalIconMap[animalId] && animalIconMap[animalId].found) {
                        icon.src = animalIconMap[animalId].found;
                    } else {
                        icon.src = animalData[animalId].icon;
                    }
                } else {
                    // Use shadow icon for unfound animals
                    if (animalIconMap[animalId] && animalIconMap[animalId].shadow) {
                        icon.src = animalIconMap[animalId].shadow;
                    } else {
                        // Fallback if no shadow icon available
                        icon.src = animalData[animalId].icon || '';
                    }
                }
                
                // Update name - use name from JSON if available, otherwise use animalData
                if (isFound) {
                    // Try to get name from JSON first
                    const animalName = getAnimalNameFromBadgeId(animalId);
                    name.textContent = animalName || animalData[animalId].name || '';
                } else {
                    // Use regular weight (400) for question marks - Amatic-Regular.ttf has the question mark
                    name.innerHTML = '<span style="font-weight: 400;">???</span>';
                }
                
                // Update date - only show if found
                if (isFound) {
                    // Get the actual collection date from userData
                    let collectionDate = null;
                    try {
                        const userData = JSON.parse(localStorage.getItem('userData') || 'null');
                        if (userData && userData.progress && userData.progress.badgeDates && userData.progress.badgeDates[animalId]) {
                            collectionDate = new Date(userData.progress.badgeDates[animalId]);
                        }
                    } catch (e) {
                        console.warn('Error retrieving animal date:', e);
                    }
                    
                    // Format and display the date
                    const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
                    
                    if (collectionDate && !isNaN(collectionDate.getTime())) {
                        // Use the stored collection date
                        const month = monthNames[collectionDate.getMonth()];
                        const day = collectionDate.getDate();
                        const year = collectionDate.getFullYear();
                        date.textContent = `Found in ${month} ${day}, ${year}`;
                    } else {
                        // Fallback to current date if no stored date (for backwards compatibility)
                        const currentDate = new Date();
                        const month = monthNames[currentDate.getMonth()];
                        const day = currentDate.getDate();
                        const year = currentDate.getFullYear();
                        date.textContent = `Found in ${month} ${day}, ${year}`;
                    }
                    date.style.display = 'block';
                } else {
                    // Hide date if not found
                    date.style.display = 'none';
                }
                
                // Update description - use description from JSON if available, otherwise fallback to animalData
                if (isFound) {
                    // Use description from JSON if available, otherwise fallback to animalData.description
                    const jsonDescription = animalDescriptionMap[animalId];
                    description.textContent = jsonDescription || animalData[animalId].description || '';
                } else {
                    description.textContent = "You haven't found this animal yet. Keep exploring to find it!";
                }
                
                // Show/hide Play Game button - only show if found and has game
                const playGameButton = document.getElementById('animalPlayGameButton');
                if (animalData[animalId].gamePath && isFound && playGameButton) {
                    playGameButton.style.display = 'flex';
                    playGameButton.setAttribute('data-game-path', animalData[animalId].gamePath);
                } else if (playGameButton) {
                    playGameButton.style.display = 'none';
                }
                
                // Show/hide 3D button - only show if found and has model
                if (threeDButton) {
                    // Check if animal has a model in JSON
                    let hasModel = false;
                    try {
                        const animalName = getAnimalNameFromBadgeId(animalId);
                        const animal = animals.find(a => a.name === animalName);
                        hasModel = animal && animal.model && animal.model.url;
                    } catch (e) {
                        console.warn('Error checking for model:', e);
                    }
                    
                    if (isFound && hasModel) {
                        threeDButton.style.display = 'flex';
                    } else {
                        threeDButton.style.display = 'none';
                    }
                }
                
                // Show overlay with slide-in animation
                popup.classList.remove('hidden');
                // Force reflow to ensure transition works
                popup.offsetHeight;
                popup.classList.add('show');
            }
        }

        function playGame() {
            // Trigger haptic feedback
            if (typeof triggerHaptic === 'function') {
                triggerHaptic('single');
            }
            const playGameButton = document.getElementById('animalPlayGameButton');
            const gamePath = playGameButton.getAttribute('data-game-path');
            if (gamePath) {
                window.location.href = gamePath;
            }
        }

        function closeAnimalDetail() {
            // Trigger haptic feedback
            if (typeof triggerHaptic === 'function') {
                triggerHaptic('single');
            }
            const popup = document.getElementById('animalDetailPopup');
            if (popup) {
                // Remove show class to trigger slide-out animation
                popup.classList.remove('show');
                
                // Wait for animation to complete before hiding
                setTimeout(() => {
                    if (popup.classList.contains('show')) return; // If shown again, don't hide
                    popup.classList.add('hidden');
                }, 300); // Match CSS transition duration
            }
        }

        // 3D Model Viewer functionality
        let currentModelViewer = null;
        let currentAnimalId = null;

        async function open3DViewer() {
            // Trigger haptic feedback
            if (typeof triggerHaptic === 'function') {
                triggerHaptic('single');
            }

            if (!currentAnimalId) {
                console.error('No animal ID set for 3D viewer');
                return;
            }

            const overlay = document.getElementById('modelViewerOverlay');
            const container = document.getElementById('modelViewerContainer');
            const arButton = document.getElementById('modelViewerARButton');

            if (!overlay || !container) {
                console.error('3D viewer elements not found');
                return;
            }

            try {
                // Load animal data from JSON
                const res = await fetch('../data/animals.json', { cache: 'no-cache' });
                const cfg = await res.json();
                const animals = Array.isArray(cfg.animals) ? cfg.animals : [];
                
                // Find the animal by badge ID
                const animalName = getAnimalNameFromBadgeId(currentAnimalId);
                const animal = animals.find(a => a.name === animalName);

                if (!animal || !animal.model || !animal.model.url) {
                    console.error('Animal model not found:', currentAnimalId);
                    alert('3D model not available for this animal.');
                    return;
                }

                // Show overlay
                overlay.classList.remove('hidden');
                overlay.offsetHeight; // Force reflow
                overlay.classList.add('show');

                // Initialize model viewer
                const modelUrl = animal.model.url.replace('../assets/', '../assets/');
                
                // Check for iOS-specific USDZ file (for AR animations on iOS)
                // iOS Quick Look doesn't preserve animations from auto-converted GLB files
                // So we need pre-converted USDZ files with animations
                const iosSrc = animal.model.usdz || animal.model.iosSrc || '';
                const iosModelUrl = iosSrc ? iosSrc.replace('../assets/', '../assets/') : '';
                
                // Destroy existing viewer if any
                if (currentModelViewer) {
                    currentModelViewer.destroy();
                }

                // Initialize new viewer
                const viewerOptions = {
                    container: container,
                    modelSrc: modelUrl,
                    backgroundColor: '#FCF6EF',
                    exposure: 1.0,
                    shadowIntensity: 0.5,
                    shadowSoftness: 1.0,
                    showControls: false,
                    showInstructions: false,
                    cameraOrbit: '0deg 75deg 1.5m',
                    cameraTarget: '0m 0m 0m',
                    arModes: 'webxr scene-viewer quick-look'
                };
                
                // Add iOS source if available (for AR animations)
                if (iosModelUrl) {
                    viewerOptions.iosSrc = iosModelUrl;
                }
                
                currentModelViewer = await SmartifyModelViewer.init(viewerOptions);

                // Check if AR is supported and show AR button
                const viewer = currentModelViewer.getViewer();
                if (viewer) {
                    viewer.addEventListener('ar-status', (event) => {
                        if (event.detail.status === 'not-presenting') {
                            // AR session ended, check if AR is available
                            checkARSupport();
                        }
                    });
                    
                    // Check AR support after a short delay
                    setTimeout(() => {
                        checkARSupport();
                    }, 500);
                }

            } catch (error) {
                console.error('Error opening 3D viewer:', error);
                alert('Failed to load 3D model. Please try again.');
            }
        }

        function close3DViewer() {
            // Trigger haptic feedback
            if (typeof triggerHaptic === 'function') {
                triggerHaptic('single');
            }

            const overlay = document.getElementById('modelViewerOverlay');
            if (overlay) {
                // Remove show class to trigger slide-out animation
                overlay.classList.remove('show');
                
                // Wait for animation to complete before hiding
                setTimeout(() => {
                    if (overlay.classList.contains('show')) return; // If shown again, don't hide
                    overlay.classList.add('hidden');
                    
                    // Destroy viewer
                    if (currentModelViewer) {
                        currentModelViewer.destroy();
                        currentModelViewer = null;
                    }
                }, 300); // Match CSS transition duration
            }
        }

        async function checkARSupport() {
            const arButton = document.getElementById('modelViewerARButton');
            if (!arButton || !currentModelViewer) return;

            const viewer = currentModelViewer.getViewer();
            if (!viewer) return;

            try {
                // Check if AR is available
                if (viewer.canActivateAR) {
                    arButton.style.display = 'block';
                } else {
                    arButton.style.display = 'none';
                }
            } catch (error) {
                console.log('AR support check failed:', error);
                arButton.style.display = 'none';
            }
        }

        async function launchAR() {
            // Trigger haptic feedback
            if (typeof triggerHaptic === 'function') {
                triggerHaptic('single');
            }

            if (!currentModelViewer) {
                console.error('No model viewer initialized');
                return;
            }

            const viewer = currentModelViewer.getViewer();
            if (!viewer || !viewer.activateAR) {
                console.error('AR not available');
                return;
            }

            try {
                await viewer.activateAR();
            } catch (error) {
                console.error('Failed to launch AR:', error);
                alert('AR is not available on this device.');
            }
        }

        // Add click event listeners to all animals (found and not found)
        function addAnimalClickListeners() {
            // Use event delegation to handle clicks on all animal items
            const animalGrid = document.querySelector('.animal-grid');
            if (animalGrid) {
                animalGrid.addEventListener('click', function(e) {
                    // Check if clicked element is an animal item
                    const animalItem = e.target.closest('.animal-item');
                    if (animalItem) {
                        // Trigger haptic feedback
                        if (typeof triggerHaptic === 'function') {
                            triggerHaptic('single');
                        }
                        const animalId = animalItem.getAttribute('data-animal');
                        if (animalId) {
                            showAnimalDetail(animalId);
                        }
                    }
                });
            }
            
            // Add cursor pointer to all animal items
            const animalItems = document.querySelectorAll('.animal-item');
            animalItems.forEach(item => {
                item.style.cursor = 'pointer';
            });
        }
        
        // Add haptic feedback to buttons with onclick
        function addHapticToButtons() {
            document.querySelectorAll('button[onclick]').forEach(button => {
                const originalOnclick = button.getAttribute('onclick');
                if (originalOnclick && !originalOnclick.includes('triggerHaptic')) {
                    button.onclick = function(e) {
                        if (typeof triggerHaptic === 'function') {
                            triggerHaptic('single');
                        }
                        eval(originalOnclick);
                    };
                }
            });
        }
        
        // Call on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addHapticToButtons);
        } else {
            addHapticToButtons();
        }
    </script>
</body>
</html>
