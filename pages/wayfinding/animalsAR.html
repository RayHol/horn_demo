<!DOCTYPE html>
<html lang="en">

<head>
    <script src="../../scripts/settings.js"></script>
    <script>
        // Intercept getUserMedia to detect and store camera permission when AR.js accesses it
        (function() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const originalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
                navigator.mediaDevices.getUserMedia = function(constraints) {
                    return originalGetUserMedia(constraints)
                        .then(stream => {
                            // Camera access successful - store permission
                            if (typeof storePermissionGrant === 'function') {
                                storePermissionGrant('camera');
                            } else {
                                try {
                                    localStorage.setItem('permission-camera-granted', 'granted');
                                } catch(_) {}
                            }
                            return stream;
                        })
                        .catch(error => {
                            // Permission denied or error
                            throw error;
                        });
                };
            }
        })();
        
        // Pre-activate geolocation if permission is already granted
        // This prevents AR.js from showing "tap screen to activate geolocation" message
        (async function() {
            try {
                // Check permission immediately (synchronously check localStorage first for speed)
                let granted = false;
                try {
                    granted = localStorage.getItem('geopin-location-permission') === 'granted' ||
                              localStorage.getItem('permission-location-granted') === 'granted';
                } catch (_) {}
                
                // If not found in localStorage, wait for settings.js and check properly
                if (!granted) {
                    // Wait for settings.js to load
                    if (typeof checkPermission === 'undefined') {
                        await new Promise(resolve => {
                            let attempts = 0;
                            const check = setInterval(() => {
                                if (typeof checkPermission !== 'undefined' || attempts++ > 20) {
                                    clearInterval(check);
                                    resolve();
                                }
                            }, 100);
                        });
                    }
                    
                    if (typeof checkPermission === 'function') {
                        granted = await checkPermission('location');
                    }
                }
                
                if (!granted) {
                    window.location.replace('./index.html');
                    return;
                }
                
                // Permission is granted - pre-activate geolocation immediately
                // This ensures AR.js's gps-camera component sees geolocation as active
                // We need to call this BEFORE AR.js initializes
                if ('geolocation' in navigator) {
                    // Start geolocation immediately to activate it for AR.js
                    // Use a very short timeout to activate quickly
                    navigator.geolocation.getCurrentPosition(
                        function() {
                            // Geolocation activated - store permission again to be sure
                            if (typeof storePermissionGrant === 'function') {
                                storePermissionGrant('location');
                            } else {
                                try {
                                    localStorage.setItem('geopin-location-permission', 'granted');
                                    localStorage.setItem('permission-location-granted', 'granted');
                                } catch(_) {}
                            }
                        },
                        function() {
                            // Error - but continue anyway
                        },
                        { enableHighAccuracy: true, timeout: 1000, maximumAge: 0 }
                    );
                    
                    // Also start watchPosition to keep geolocation active
                    // This ensures AR.js sees it as continuously active
                    navigator.geolocation.watchPosition(
                        function() {
                            // Position received - geolocation is active
                        },
                        function() {
                            // Error
                        },
                        { enableHighAccuracy: true, timeout: 1000, maximumAge: 0 }
                    );
                }
            } catch (_) { /* if storage blocked, just continue */ }
        })();
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, height=device-height, minimum-scale=1, maximum-scale=1, initial-scale=1, user-scalable=no, user-scalable=0"/>
    <title>Geo-AnimalsAR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script type='text/javascript' src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/3.4.7/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script>
        THREEx.ArToolkitContext.baseURL = 'https://raw.githack.com/jeromeetienne/ar.js/master/three.js/'
    </script>
    <script src="../../scripts/customer-io-helper.js"></script>
    <script src="../../scripts/wayfinding/script.js"></script>
    <link rel="stylesheet" type="text/css" href="../../styles/wayfinding/style.css"/>
    <script>
        // Camera permission is handled by the getUserMedia interceptor above
        // AR.js will initialize normally, and the interceptor will store permission when camera is accessed
        // No need to delay scene initialization - A-Frame/AR.js can handle permission requests
    </script>
    <style>
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body style='margin: 0; overflow: hidden; background: var(--Background-main);'>
    <!-- AR Overlay -->
    <div class="ar-overlay">
        <div class="ar-overlay__background"></div>
        <div class="ar-overlay__cutout" id="arCutout">
            <!-- Corner graphics -->
            <img src="../../assets/wayfinding/ui/corner-path.svg" alt="" class="ar-corner ar-corner--top-left">
            <img src="../../assets/wayfinding/ui/corner-path.svg" alt="" class="ar-corner ar-corner--top-right">
            <img src="../../assets/wayfinding/ui/corner-path.svg" alt="" class="ar-corner ar-corner--bottom-left">
            <img src="../../assets/wayfinding/ui/corner-path.svg" alt="" class="ar-corner ar-corner--bottom-right">
        </div>
        <a href="./wayfinding.html" class="ar-overlay__back-button" aria-label="Back to wayfinding page"></a>
        <div class="ar-overlay__title">FIND THE ANIMALS</div>
        <div class="centered instructions"></div>
    </div>
    <a-scene 
        id="arScene"
        xr-mode-ui='enabled: false' 
        embedded
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;'>
    <a-camera id="mainCamera" gps-camera rotation-reader raycaster="objects: .detectable, .detectable *; interval: 200; far: 1000"></a-camera>
    
    <!-- Lighting -->
    <!-- Ambient light for general scene illumination -->
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.2;"></a-entity>
    
    <!-- Directional light to simulate sunlight and add depth -->
    <!-- <a-entity light="type: directional; color: #ffffff; intensity: 1; position: 1 3 2;"></a-entity> -->
    
    <!-- Note: Light estimation would require WebXR (not available with AR.js marker-based AR) -->
    <a-entity light-estimation></a-entity>
</a-scene>
<div class="centered">
    <button data-action="camera-btn" title="Camera action" aria-label="Camera action"></button>
</div>
<div class="centered centered--debug">
    <div id="proximityDebug" style="font-size: 0.9em; color: var(--Texts-textWhite); text-align: center; font-family: 'BentonSans Book', sans-serif;"></div>
</div>
<!-- Badge Congratulations Splash (4s auto-dismiss) -->
<div id="badgeSplash" class="badge-splash hidden">
  <div class="starburst-background-overlay"></div>
  <div class="splash-content">
    <img id="badgeSplashIcon" src="" class="splash-badge-icon">
    <h1 class="splash-title">Congratulations</h1>
    <p class="splash-subtitle">You earned a badge!</p>
  </div>
</div>

<!-- Badge Collection Detail Screen -->
<div id="badgeCollection" class="badge-collection hidden">
  <div class="starburst-background-overlay"></div>
  <div class="badge-detail-content">
    <img id="badgeDetailIcon" src="" class="badge-detail-icon">
    <h2 id="badgeDetailName" class="badge-name"></h2>
    <p id="badgeDetailDescription" class="badge-description"></p>
    <div class="badge-buttons">
      <button id="playGameButton" class="secondaryButton" onclick="playGame()" style="display: none;">Play Game</button>
      <button class="primaryButton" onclick="goHome()">Back to the map</button>
    </div>
  </div>
</div>

<div class="loader-overlay" id="sceneLoader">
    <div class="loader"></div>
    
</div>
<audio id="tada-audio" src="../../games/anemone-cleaning/assets/audio/tada.mp3" preload="auto"></audio>
</body>

</html>

