<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Animals Everywhere! - Wayfinding Map</title>
    <link rel="preload" href="../../assets/fonts/Amatic SC Regular.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="preload" href="../../assets/fonts/Amatic-Bold.ttf" as="font" type="font/ttf" crossorigin>
    <link rel="stylesheet" href="../../styles/wayfinding/style.css">
    <link rel="stylesheet" href="../../styles/wayfinding/wayfinding.css">
    <link rel="stylesheet" href="../../styles/settings.css">
    
    <!-- Mapbox GL JS CSS -->
    <link rel="preconnect" href="https://api.mapbox.com" crossorigin>
    <link id="mapbox-css" rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css">
    <script>
      // Ensure Mapbox CSS is actually applied; if not, inject a fallback.
      (function ensureMapboxCSS(){
        function hasMapboxCSS(){
          try {
            return Array.from(document.styleSheets).some(ss => (ss.href||"").includes("mapbox-gl.css"));
          } catch { return false; }
        }

        const link = document.getElementById('mapbox-css');
        link.addEventListener('error', function () {
          var alt = document.createElement('link');
          alt.rel = 'stylesheet';
          alt.href = 'https://unpkg.com/mapbox-gl@3.14.0/dist/mapbox-gl.css';
          document.head.appendChild(alt);
          console.warn('[Mapbox] Primary CSS failed â€” using fallback CDN.');
        });

        function lateCheck(){
          if (!hasMapboxCSS()) {
            var alt = document.createElement('link');
            alt.rel = 'stylesheet';
            alt.href = 'https://unpkg.com/mapbox-gl@3.14.0/dist/mapbox-gl.css';
            document.head.appendChild(alt);
            console.warn('[Mapbox] No Mapbox CSS detected â€” injected fallback.');
          }
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', lateCheck);
        } else {
          lateCheck();
        }
      })();
    </script>
</head>
<body>
    <button class="back-button" id="backButton" aria-label="Back to menu">
        <img src="../../assets/wayfinding/ui/Arrow.svg" alt="Back">
    </button>
    
    <button class="help-button" id="settingsButton" aria-label="Settings">
        <img src="../../assets/Settings.png" alt="Settings">
    </button>
    
    <!-- Orientation Warning Overlay -->
    <div id="orientationOverlay" class="orientation-overlay hidden">
        <div class="orientation-content">
            <div class="orientation-icon">ðŸ“±</div>
            <h2>Please Rotate Your Device</h2>
            <p>Hold your device in portrait mode for the best experience</p>
        </div>
    </div>

    <!-- Instructions Overlay -->
    <div id="instructionsOverlay" class="instructions-overlay hidden">
        <div class="instructions-content">
            <h2>HOW TO USE THE MAP</h2>
            <ul>
                <li>
                    <img src="../../assets/wayfinding/ui/playerLocation.svg" alt="" class="instruction-icon">
                    <span>Move around and watch your location on the map</span>
                </li>
                <li>
                    <img src="../../assets/wayfinding/ui/Fox v2.0.svg" alt="" class="instruction-icon">
                    <span>Follow hotspots to find animals</span>
                </li>
                <li>
                    <img src="../../assets/wayfinding/ui/Alert.svg" alt="" class="instruction-icon">
                    <span>You will get an alert when you are close</span>
                </li>
                <li>
                    <img src="../../assets/wayfinding/ui/Scan2.svg" alt="" class="instruction-icon">
                    <span>Scan the area to locate the animal and collect a badge</span>
                </li>
            </ul>
            <button class="instructions-close" id="instructionsClose">Got it!</button>
        </div>
    </div>

    <!-- Leave Confirmation Overlay -->
    <div id="leaveConfirmationOverlay" class="instructions-overlay hidden">
        <div class="instructions-content">
            <h2>Leaving the map</h2>
            <p class="leave-confirm-message">Stay on this page to be notified where animals are.</p>
            <div class="leave-confirm-buttons">
                <button class="leave-confirm-close" id="leaveConfirmClose">âœ•</button>
                <button class="instructions-close" id="leaveConfirmButton">Leave</button>
            </div>
        </div>
    </div>

    <!-- Boundary Warning Overlay -->
    <div id="boundaryWarningOverlay" class="instructions-overlay hidden">
        <div class="instructions-content">
            <button class="boundary-warning-close" id="boundaryWarningClose">âœ•</button>
            <h2>Out of bounds</h2>
            <p class="boundary-warning-message">There are no animals here!Return to the garden grounds to continue your search.</p>
        </div>
    </div>

    <!-- Animal Nearby Popup (slides in from bottom) -->
    <div id="animalNearbyPopup" class="animal-detail-popup hidden">
        <div class="animal-detail-content">
            <button class="animal-detail-close" id="animalNearbyClose" aria-label="Close">
                <img src="../../assets/wayfinding/ui/close_button.png" alt="Close">
            </button>
            <h2 class="animal-detail-title" id="animalNearbyTitle">AN ANIMAL IS NEARBY!</h2>
            <p class="animal-detail-message" id="animalNearbyMessage">Open the camera to scan the area.</p>
            <div class="animal-detail-buttons">
                <button class="animal-detail-btn directions-btn" id="animalNearbyOpenCamera">
                    <img src="../../assets/wayfinding/ui/Scan.svg" alt="Scan" class="btn-icon">
                    <span>Open camera</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Proximity Info Panel (shows when within 20-25m range) -->
    <div id="proximityNotification" class="proximity-notification hidden"></div>

    <!-- Zoom and Recenter Buttons -->
    <button id="zoomInBtn" class="zoom-btn" aria-label="Zoom in">
        <img src="../../assets/wayfinding/ui/Plus.svg" alt="Zoom in">
    </button>
    <button id="zoomOutBtn" class="zoom-btn" aria-label="Zoom out">
        <img src="../../assets/wayfinding/ui/Minus.svg" alt="Zoom out">
    </button>
    <button id="recenterBtn" class="recenter-btn" aria-label="Recenter map to your location">
        <img src="../../assets/wayfinding/ui/Target.svg" alt="Recenter">
    </button>

    <!-- Map Container -->
    <div class="map-container" id="mapContainer">
        <img src="../../assets/wayfinding/horniman_map_new.png" alt="Interactive Map" class="map-image" id="mapImage">
        <div class="user-location-accuracy-circle" id="userLocationAccuracyCircle"></div>
        <div class="user-location-dot" id="userLocationDot"></div>
        <div class="user-location-heading" id="userLocationHeading"></div>
        <div id="animalHotspots"></div>
        <!-- Mapbox overlay for route drawing -->
        <div id="mapboxOverlay" class="mapbox-overlay"></div>
    </div>

    <!-- Animal Detail Popup (slides in from bottom) -->
    <div id="animalDetailPopup" class="animal-detail-popup hidden">
        <div class="animal-detail-content">
            <button class="animal-detail-close" id="animalDetailClose" aria-label="Close">
                <img src="../../assets/wayfinding/ui/close_button.png" alt="Close">
            </button>
            <h2 class="animal-detail-title" id="animalDetailTitle">???</h2>
            <p class="animal-detail-message" id="animalDetailMessage">What could this be?</p>
            <div class="animal-detail-buttons">
                <button class="animal-detail-btn directions-btn" id="animalDetailDirections">
                    <img src="../../assets/wayfinding/ui/Directions.svg" alt="Directions" class="btn-icon">
                    <span>Directions</span>
                </button>
                <button class="animal-detail-btn details-btn" id="animalDetailDetails">
                    <img src="../../assets/wayfinding/ui/Details.svg" alt="Details" class="btn-icon">
                    <span>Details</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Directions Popup (slides in from bottom) -->
    <div id="directionsPopup" class="animal-detail-popup hidden">
        <div class="animal-detail-content">
            <button class="animal-detail-close" id="directionsClose" aria-label="Close">
                <img src="../../assets/wayfinding/ui/close_button.png" alt="Close">
            </button>
            <h2 class="animal-detail-title" id="directionsTitle">0M AWAY</h2>
            <p class="animal-detail-message" id="directionsMessage">Your route is ready. Head to the marked area to scan this animal.</p>
            <div class="animal-detail-buttons">
                <button class="animal-detail-btn directions-btn" id="directionsClearRoute">
                    <img src="../../assets/wayfinding/ui/Directions.svg" alt="Clear Route" class="btn-icon">
                    <span>Clear Route</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Animal Details Overlay (full screen, like animals page) -->
    <div id="animalDetailsOverlay" class="badge-detail-popup hidden">
        <div class="starburst-background-overlay"></div>
        <button class="back-button" id="animalDetailsBackButton">
            <img src="../../assets/Arrow.png" alt="Back">
        </button>
        <h1 class="title">ANIMAL DETAILS</h1>
        
        <div class="badge-detail-main">
            <img id="animalDetailsIcon" src="" alt="Animal" class="badge-detail-icon">
            <h2 id="animalDetailsName" class="badge-detail-name"></h2>
            <p id="animalDetailsDate" class="badge-detail-date"></p>
            <p id="animalDetailsDescription" class="badge-detail-description"></p>
            <div class="badge-detail-buttons">
                <button id="animalDetailsPlayGameButton" class="secondaryButton hidden">Play Game</button>
            </div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-dialog">
            <button class="close-button" aria-label="Close settings">
                <img src="../../assets/close_button.png" alt="Close">
            </button>
            <h2>Settings</h2>
            <h3>Hello, <span id="userNickname">Guest</span>!</h3>
            <div class="settings-controls">
                <button id="hapticsToggle" class="settings-icon-button" aria-label="Toggle Haptics">
                    <img src="../../assets/Haptics.png" alt="Haptics" class="settings-icon-img">
                </button>
                <button id="audioToggle" class="settings-icon-button" aria-label="Toggle Audio">
                    <img src="../../assets/Unmute.png" alt="Sound" class="settings-icon-img">
                </button>
                <button id="musicToggle" class="settings-icon-button" aria-label="Toggle Music">
                    <img src="../../assets/Note.png" alt="Music" class="settings-icon-img">
                </button>
            </div>
            <button class="how-to-play-button">
                <span>?</span>
                How to play
            </button>
        </div>
    </div>

    <!-- Customer.io Helper (loads before Customer.io snippet) -->
    <script src="../../scripts/customer-io-helper.js"></script>
    <!-- Customer.io snippet will go here when available -->
    
    <!-- Mapbox GL JS (with fallback) -->
    <script id="mapbox-js" src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js" defer></script>
    <script>
      (function(){
        const primary = document.getElementById('mapbox-js');
        primary.addEventListener('error', function(){
          console.warn('[Mapbox] Primary JS failed â€” trying fallback CDN.');
          var s = document.createElement('script');
          s.src = 'https://unpkg.com/mapbox-gl@3.14.0/dist/mapbox-gl.js';
          s.defer = true;
          document.head.appendChild(s);
        });
      })();
    </script>
    
    <script src="../../scripts/audio-manager-main.js"></script>
    <script src="../../scripts/settings.js"></script>
    <script src="../../scripts/wayfinding/map-config.js"></script>
    <script src="../../scripts/wayfinding/mapbox-directions.js"></script>
    <script src="../../scripts/wayfinding/wayfinding.js"></script>
</body>
</html>

